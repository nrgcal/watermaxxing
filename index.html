<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watermaxxing</title>
</head>
<body style="margin:0; padding:0;">

<!-- ═══════════════════════════════════════════════════════════════════════════
     WATERMAXXING.COM - DIGITAL BUSINESS CARD v3
     VAPORWAVE/SYNTHWAVE EDITION - WITH SLIDE-UP GAME
     Width: 100% | Height: 4200px
═══════════════════════════════════════════════════════════════════════════ -->

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

<style>
@keyframes neonPulse {
  0%, 100% { text-shadow: 0 0 10px #ff00ff, 0 0 20px #ff00ff, 0 0 40px #ff00ff; }
  50% { text-shadow: 0 0 5px #ff00ff, 0 0 10px #ff00ff, 0 0 20px #ff00ff; }
}
@keyframes borderGlow {
  0%, 100% { box-shadow: 0 0 15px rgba(255,0,255,0.5), inset 0 0 15px rgba(255,0,255,0.1); }
  50% { box-shadow: 0 0 25px rgba(255,0,255,0.8), inset 0 0 25px rgba(255,0,255,0.2); }
}
@keyframes float {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  50% { transform: translateY(-15px) rotate(2deg); }
}
@keyframes orbFloat {
  0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.6; }
  25% { transform: translate(40px, -30px) scale(1.1); opacity: 0.8; }
  50% { transform: translate(-20px, -50px) scale(0.9); opacity: 0.5; }
  75% { transform: translate(-40px, -20px) scale(1.05); opacity: 0.7; }
}
@keyframes orbFloat2 {
  0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.5; }
  33% { transform: translate(-50px, 30px) scale(1.15); opacity: 0.7; }
  66% { transform: translate(30px, -40px) scale(0.85); opacity: 0.4; }
}
@keyframes scanMove {
  0% { top: -10%; }
  100% { top: 110%; }
}
@keyframes statusPulse {
  0%, 100% { opacity: 1; box-shadow: 0 0 12px #00ff88; }
  50% { opacity: 0.5; box-shadow: 0 0 6px #00ff88; }
}
@keyframes glitch {
  0%, 90%, 100% { transform: translate(0); }
  92% { transform: translate(-2px, 1px); }
  94% { transform: translate(2px, -1px); }
  96% { transform: translate(-1px, -1px); }
  98% { transform: translate(1px, 1px); }
}
@keyframes starTwinkle {
  0%, 100% { opacity: 0.3; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.5); }
}
@keyframes ringPulse {
  0%, 100% { transform: scale(1); opacity: 0.3; }
  50% { transform: scale(1.1); opacity: 0.6; }
}
@keyframes slideUp {
  0% { transform: translateY(100%); }
  100% { transform: translateY(0); }
}
@keyframes slideDown {
  0% { transform: translateY(0); }
  100% { transform: translateY(100%); }
}
.neon-text { animation: neonPulse 2s ease-in-out infinite; }
.float { animation: float 6s ease-in-out infinite; }
.glow-border { animation: borderGlow 3s ease-in-out infinite; }
.status-dot { animation: statusPulse 2s ease-in-out infinite; }
.glitch { animation: glitch 3s ease-in-out infinite; }
.orb1 { animation: orbFloat 20s ease-in-out infinite; }
.orb2 { animation: orbFloat2 25s ease-in-out infinite; }
.star { animation: starTwinkle 2s ease-in-out infinite; }
.ring { animation: ringPulse 4s ease-in-out infinite; }
.game-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
.game-slide-down { animation: slideDown 0.3s ease-in forwards; }
</style>

<div style="font-family: 'Inter', -apple-system, sans-serif; line-height: 1.5; background: #0d0221; color: #fff; max-width: 100%; margin: 0; padding: 0; overflow-x: hidden;">

<!-- === HERO === -->

<div style="padding: 3rem 1.5rem 2rem; background: linear-gradient(180deg, #0d0221 0%, #1a0a2e 40%, #16082a 100%); position: relative; overflow: hidden; min-height: 480px;">

  <!-- Animated scanline -->

  <div style="position: absolute; top: -10%; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, rgba(255,0,255,0.5), transparent); animation: scanMove 4s linear infinite; pointer-events: none; z-index: 15;"></div>

  <!-- CRT scanline overlay -->

  <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.15) 2px, rgba(0,0,0,0.15) 4px); pointer-events: none; z-index: 12;"></div>

  <!-- Animated grid floor -->

  <div style="position: absolute; bottom: 0; left: -100%; right: -100%; height: 60%; background-image: linear-gradient(rgba(255,0,255,0.15) 1px, transparent 1px), linear-gradient(90deg, rgba(255,0,255,0.15) 1px, transparent 1px); background-size: 50px 50px; transform: perspective(500px) rotateX(60deg); pointer-events: none; opacity: 0.4;"></div>

  <!-- Floating orbs -->

  <div class="orb1" style="position: absolute; top: 5%; left: -15%; width: 350px; height: 350px; background: radial-gradient(circle, rgba(255,0,255,0.3) 0%, transparent 60%); border-radius: 50%; filter: blur(50px); pointer-events: none;"></div>
  <div class="orb2" style="position: absolute; top: 15%; right: -20%; width: 400px; height: 400px; background: radial-gradient(circle, rgba(0,255,255,0.2) 0%, transparent 60%); border-radius: 50%; filter: blur(60px); pointer-events: none;"></div>
  <div class="orb1" style="position: absolute; bottom: 20%; left: 10%; width: 200px; height: 200px; background: radial-gradient(circle, rgba(255,0,255,0.15) 0%, transparent 70%); border-radius: 50%; filter: blur(40px); pointer-events: none;"></div>

  <!-- Stars -->

  <div class="star" style="position: absolute; top: 12%; left: 15%; width: 3px; height: 3px; background: #fff; border-radius: 50%; box-shadow: 0 0 6px #fff;"></div>
  <div class="star" style="position: absolute; top: 25%; right: 20%; width: 2px; height: 2px; background: #00ffff; border-radius: 50%; box-shadow: 0 0 8px #00ffff; animation-delay: 0.5s;"></div>
  <div class="star" style="position: absolute; top: 8%; right: 30%; width: 2px; height: 2px; background: #ff00ff; border-radius: 50%; box-shadow: 0 0 6px #ff00ff; animation-delay: 1s;"></div>
  <div class="star" style="position: absolute; top: 35%; left: 8%; width: 2px; height: 2px; background: #fff; border-radius: 50%; box-shadow: 0 0 4px #fff; animation-delay: 1.5s;"></div>

  <div style="max-width: 420px; margin: 0 auto; position: relative; z-index: 5;">

```
<!-- Logo/Brand -->
<div class="glitch" style="text-align: center; margin-bottom: 1.5rem;">
  <div style="font-family: 'Orbitron', sans-serif; font-size: 1.375rem; font-weight: 800; letter-spacing: 0.1em; text-transform: uppercase; color: #ff00ff;" class="neon-text">
    watermaxxing
  </div>
  <div style="font-family: 'JetBrains Mono', monospace; font-size: 9px; letter-spacing: 0.5em; text-transform: uppercase; color: rgba(255,255,255,0.25); margin-top: 3px;">.com</div>
</div>

<!-- Large Avatar with rings -->
<div class="float" style="text-align: center; margin-bottom: 1.25rem;">
  <div style="position: relative; display: inline-block;">
    <div class="ring" style="position: absolute; top: -12px; left: -12px; right: -12px; bottom: -12px; border: 2px solid rgba(255,0,255,0.3); border-radius: 50%;"></div>
    <div class="ring" style="position: absolute; top: -6px; left: -6px; right: -6px; bottom: -6px; border: 1px solid rgba(0,255,255,0.4); border-radius: 50%; animation-delay: 0.5s;"></div>
    <img src="https://ugc.production.linktr.ee/5dad016f-c443-42e7-8c23-c6d49785ae72_IMG-0940.jpeg?io=true&size=avatar-v3_0" alt="Barron Sawyer" style="width: 130px; height: 130px; border-radius: 50%; object-fit: cover; border: 3px solid #ff00ff; box-shadow: 0 0 40px rgba(255,0,255,0.6), 0 0 80px rgba(255,0,255,0.3), inset 0 0 30px rgba(255,0,255,0.1);">
    <div class="status-dot" style="position: absolute; bottom: 8px; right: 8px; width: 22px; height: 22px; background: #00ff88; border-radius: 50%; border: 4px solid #0d0221;"></div>
  </div>
</div>

<!-- Name & Bio -->
<div style="text-align: center; margin-bottom: 1.5rem;">
  <h1 style="font-family: 'Orbitron', sans-serif; font-size: 1.375rem; font-weight: 700; color: #fff; margin: 0 0 0.625rem 0;">Barron Sawyer, JD</h1>
  <p style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: rgba(255,255,255,0.55); line-height: 1.7; margin: 0; padding: 0 1rem;">
    water treatment solutions that hold up irl<br>
    <span style="color: #00ffff;">full wtp & wwtp delivery</span> · 450+ mobile fleet · westech · since 1973
  </p>
</div>

<!-- Social Icons Row -->
<div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 2rem;">
  <a href="tel:8012905565" style="display: flex; align-items: center; justify-content: center; width: 46px; height: 46px; background: rgba(255,0,255,0.15); border: 1px solid rgba(255,0,255,0.4); border-radius: 50%; color: #ff00ff; text-decoration: none;">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
  </a>
  <a href="https://x.com/bsawyer" target="_blank" style="display: flex; align-items: center; justify-content: center; width: 46px; height: 46px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 50%; color: #fff; text-decoration: none;">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
  </a>
  <a href="https://instagram.com/bearsaw" target="_blank" style="display: flex; align-items: center; justify-content: center; width: 46px; height: 46px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 50%; color: #fff; text-decoration: none;">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5"/><circle cx="12" cy="12" r="4"/><circle cx="18" cy="6" r="1.5" fill="currentColor"/></svg>
  </a>
  <a href="https://twitch.tv/barronsawyer" target="_blank" style="display: flex; align-items: center; justify-content: center; width: 46px; height: 46px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 50%; color: #fff; text-decoration: none;">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714Z"/></svg>
  </a>
  <a href="https://www.linkedin.com/in/sawyerlaw/" target="_blank" style="display: flex; align-items: center; justify-content: center; width: 46px; height: 46px; background: rgba(0,255,255,0.15); border: 1px solid rgba(0,255,255,0.4); border-radius: 50%; color: #00ffff; text-decoration: none;">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/></svg>
  </a>
  <a href="https://www.threads.com/bearsaw" target="_blank" style="display: flex; align-items: center; justify-content: center; width: 46px; height: 46px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 50%; color: #fff; text-decoration: none;">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12.186 24h-.007c-3.581-.024-6.334-1.205-8.184-3.509C2.35 18.44 1.5 15.586 1.472 12.01v-.017c.03-3.579.879-6.43 2.525-8.482C5.845 1.205 8.6.024 12.18 0h.014c2.746.02 5.043.725 6.826 2.098 1.677 1.29 2.858 3.13 3.509 5.467l-2.04.569c-1.104-3.96-3.898-5.984-8.304-6.015-2.91.022-5.11.936-6.54 2.717C4.307 6.504 3.616 8.914 3.59 12c.025 3.086.718 5.496 2.057 7.164 1.43 1.783 3.631 2.698 6.54 2.717 2.623-.02 4.358-.631 5.8-2.045 1.647-1.613 1.618-3.593 1.09-4.798-.31-.71-.873-1.3-1.634-1.75-.192 1.352-.622 2.446-1.284 3.272-.886 1.102-2.14 1.704-3.73 1.79-1.202.065-2.361-.218-3.259-.801-1.063-.689-1.685-1.74-1.752-2.96-.065-1.182.408-2.256 1.33-3.022.88-.73 2.082-1.146 3.39-1.17 1.016-.02 1.97.14 2.849.476-.03-.986-.18-1.79-.45-2.404-.387-.882-1.065-1.325-2.073-1.357-1.521-.047-2.404.655-2.62 2.082l-2.032-.309c.34-2.334 2.074-3.643 4.608-3.593 1.634.032 2.893.674 3.638 1.855.547.866.84 1.97.898 3.375.535.212 1.02.47 1.453.772 1.133.79 1.948 1.86 2.366 3.105.603 1.796.506 4.396-1.673 6.527-1.87 1.826-4.215 2.64-7.378 2.664z"/></svg>
  </a>
</div>
```

  </div>
</div>

<!-- === BOOKING SECTION === -->

<div style="padding: 0 1.5rem 2rem; background: linear-gradient(180deg, #16082a 0%, #0d0221 100%);">
  <div style="max-width: 420px; margin: 0 auto;">

```
<div style="font-family: 'JetBrains Mono', monospace; font-size: 9px; letter-spacing: 0.25em; text-transform: uppercase; color: rgba(255,255,255,0.3); margin-bottom: 12px; text-align: center;">// book a meeting</div>

<div style="display: flex; flex-direction: column; gap: 10px;">
  
  <a href="https://calendly.com/bsaw" target="_blank" class="glow-border" style="display: flex; align-items: center; gap: 14px; padding: 16px 18px; background: linear-gradient(135deg, rgba(255,0,255,0.25), rgba(255,0,255,0.1)); border: 1px solid rgba(255,0,255,0.5); border-radius: 14px; text-decoration: none; color: #fff;">
    <div style="width: 44px; height: 44px; background: linear-gradient(135deg, #ff00ff, #cc00cc); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/><circle cx="12" cy="15" r="2"/></svg>
    </div>
    <div style="flex: 1;">
      <div style="font-family: 'Orbitron', sans-serif; font-size: 14px; font-weight: 600;">Book a Meeting</div>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: rgba(255,255,255,0.5);">calendly · works with everything</div>
    </div>
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
  </a>
  
  <a href="https://outlook.office.com/bookwithme/user/bsawyer@westechwater.com" target="_blank" style="display: flex; align-items: center; gap: 14px; padding: 16px 18px; background: rgba(0,255,255,0.08); border: 1px solid rgba(0,255,255,0.25); border-radius: 14px; text-decoration: none; color: #fff;">
    <div style="width: 44px; height: 44px; background: rgba(0,255,255,0.15); border: 1px solid rgba(0,255,255,0.4); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#00ffff" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01"/></svg>
    </div>
    <div style="flex: 1;">
      <div style="font-family: 'Orbitron', sans-serif; font-size: 14px; font-weight: 600;">Book via Outlook</div>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: rgba(255,255,255,0.5);">microsoft 365 · enterprise</div>
    </div>
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
  </a>
  
</div>
```

  </div>
</div>

<!-- === CONTACT LINKS === -->

<div style="padding: 0 1.5rem 2rem; background: #0d0221;">
  <div style="max-width: 420px; margin: 0 auto;">

```
<div style="display: flex; flex-direction: column; gap: 10px;">
  
  <a href="/cdn-cgi/l/email-protection#62001103151b0710221507111607010a15031607104c010d0f" style="display: flex; align-items: center; gap: 14px; padding: 16px 18px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; text-decoration: none; color: #fff;">
    <div style="width: 44px; height: 44px; background: rgba(255,0,255,0.1); border: 1px solid rgba(255,0,255,0.3); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#ff00ff" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 6l-10 7L2 6"/></svg>
    </div>
    <div style="flex: 1;">
      <div style="font-family: 'Orbitron', sans-serif; font-size: 14px; font-weight: 600;">Send a Note</div>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: rgba(255,255,255,0.5);">direct to inbox</div>
    </div>
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
  </a>
  
  <a href="https://teams.microsoft.com/l/chat/0/0?users=bsawyer@westechwater.com" target="_blank" style="display: flex; align-items: center; gap: 14px; padding: 16px 18px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; text-decoration: none; color: #fff;">
    <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><path d="M8 10h8M8 14h4"/></svg>
    </div>
    <div style="flex: 1;">
      <div style="font-family: 'Orbitron', sans-serif; font-size: 14px; font-weight: 600;">Message via Teams</div>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: rgba(255,255,255,0.5);">instant chat</div>
    </div>
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
  </a>
  
  <a href="https://www.linkedin.com/in/sawyerlaw/" target="_blank" style="display: flex; align-items: center; gap: 14px; padding: 16px 18px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; text-decoration: none; color: #fff;">
    <div style="width: 44px; height: 44px; background: rgba(0,255,255,0.1); border: 1px solid rgba(0,255,255,0.3); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="#00ffff"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/></svg>
    </div>
    <div style="flex: 1;">
      <div style="font-family: 'Orbitron', sans-serif; font-size: 14px; font-weight: 600;">View LinkedIn Profile</div>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: rgba(255,255,255,0.5);">#1 american water treatment pro on social</div>
    </div>
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
  </a>
  
  <a href="https://x.com/bsawyer" target="_blank" style="display: flex; align-items: center; gap: 14px; padding: 16px 18px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; text-decoration: none; color: #fff;">
    <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="#fff"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
    </div>
    <div style="flex: 1;">
      <div style="font-family: 'Orbitron', sans-serif; font-size: 14px; font-weight: 600;">@bsawyer</div>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: rgba(255,255,255,0.5);">thoughts & threads</div>
    </div>
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
  </a>
  
</div>
```

  </div>
</div>

<!-- === ARTICLES === -->

<div style="padding: 2rem 1.5rem; background: linear-gradient(180deg, #0d0221, #1a0533);">
  <div style="max-width: 420px; margin: 0 auto;">

```
<div style="font-family: 'JetBrains Mono', monospace; font-size: 9px; letter-spacing: 0.25em; text-transform: uppercase; color: rgba(255,255,255,0.3); margin-bottom: 12px; text-align: center;">.:: Articles, Etc. ::.</div>

<div style="display: flex; flex-direction: column; gap: 8px;">
  
  <a href="https://www.linkedin.com/pulse/why-so-many-industries-outsourcing-water-operations-us-sawyer-jd-tbrfc" target="_blank" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; text-decoration: none; color: #fff;">
    <div style="width: 40px; height: 40px; border-radius: 8px; background: rgba(0,255,255,0.1); border: 1px solid rgba(0,255,255,0.3); display: flex; align-items: center; justify-content: center;">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00ffff" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
    </div>
    <div style="flex: 1; min-width: 0;"><div style="font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Why Industries Outsource Water Ops</div></div>
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="2"><path d="M7 17L17 7M17 7H7M17 7v10"/></svg>
  </a>
  
  <a href="https://www.linkedin.com/pulse/why-transfer-water-treatment-assets-westech-now-barron-sawyer-jd-t03zc" target="_blank" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; text-decoration: none; color: #fff;">
    <div style="width: 40px; height: 40px; border-radius: 8px; background: rgba(255,0,255,0.1); border: 1px solid rgba(255,0,255,0.3); display: flex; align-items: center; justify-content: center;">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ff00ff" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
    </div>
    <div style="flex: 1; min-width: 0;"><div style="font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Why Transfer Assets to WesTech</div></div>
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="2"><path d="M7 17L17 7M17 7H7M17 7v10"/></svg>
  </a>
  
  <a href="https://www.linkedin.com/pulse/why-gallons-megawatts-emerging-growth-filter-barron-sawyer-lriqc" target="_blank" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; text-decoration: none; color: #fff;">
    <div style="width: 40px; height: 40px; border-radius: 8px; background: rgba(0,255,255,0.1); border: 1px solid rgba(0,255,255,0.3); display: flex; align-items: center; justify-content: center;">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00ffff" stroke-width="2"><rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/><path d="M6 6h.01M6 18h.01"/></svg>
    </div>
    <div style="flex: 1; min-width: 0;"><div style="font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Data Centers × Water</div></div>
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="2"><path d="M7 17L17 7M17 7H7M17 7v10"/></svg>
  </a>
  
  <a href="https://www.linkedin.com/pulse/future-selenium-nitrate-removal-mining-ebr-explained-sawyer-jd-5yvwc" target="_blank" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; text-decoration: none; color: #fff;">
    <div style="width: 40px; height: 40px; border-radius: 8px; background: rgba(255,0,255,0.1); border: 1px solid rgba(255,0,255,0.3); display: flex; align-items: center; justify-content: center;">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ff00ff" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v3"/></svg>
    </div>
    <div style="flex: 1; min-width: 0;"><div style="font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Interview: EBR System for Selenium</div></div>
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="2"><path d="M7 17L17 7M17 7H7M17 7v10"/></svg>
  </a>
  
  <a href="https://www.linkedin.com/pulse/barron-sawyer-07-water-treatment-heart-americas-barron-sawyer-jd-i3sxc/" target="_blank" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; text-decoration: none; color: #fff;">
    <div style="width: 40px; height: 40px; border-radius: 8px; background: rgba(0,255,255,0.1); border: 1px solid rgba(0,255,255,0.3); display: flex; align-items: center; justify-content: center;">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00ffff" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
    </div>
    <div style="flex: 1; min-width: 0;"><div style="font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">UCLA Alumni Feature</div></div>
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="2"><path d="M7 17L17 7M17 7H7M17 7v10"/></svg>
  </a>
  
  <a href="https://www.linkedin.com/pulse/zion-shores-surf-park-southern-utah-barron-sawyer-wjwdc" target="_blank" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; text-decoration: none; color: #fff;">
    <div style="width: 40px; height: 40px; border-radius: 8px; background: rgba(255,0,255,0.1); border: 1px solid rgba(255,0,255,0.3); display: flex; align-items: center; justify-content: center;">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ff00ff" stroke-width="2"><path d="M2 12c2-2 4-3 6-3s4 2 6 2 4-2 6-2"/><path d="M2 16c2-2 4-3 6-3s4 2 6 2 4-2 6-2"/><path d="M2 20c2-2 4-3 6-3s4 2 6 2 4-2 6-2"/></svg>
    </div>
    <div style="flex: 1; min-width: 0;"><div style="font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Project: Surf Park Water Treatment</div></div>
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="2"><path d="M7 17L17 7M17 7H7M17 7v10"/></svg>
  </a>
  
  <a href="https://www.linkedin.com/posts/sawyerlaw_24-hours-to-hit-qatars-desert-no-heads-upjust-activity-7303395187764998146-BgKH" target="_blank" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: rgba(0,255,255,0.05); border: 1px solid rgba(0,255,255,0.15); border-radius: 12px; text-decoration: none; color: #fff;">
    <div style="width: 40px; height: 40px; border-radius: 8px; background: rgba(0,255,255,0.15); border: 1px solid rgba(0,255,255,0.4); display: flex; align-items: center; justify-content: center;">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00ffff" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
    </div>
    <div style="flex: 1; min-width: 0;"><div style="font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Story: My First Week as a Salesman</div></div>
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="2"><path d="M7 17L17 7M17 7H7M17 7v10"/></svg>
  </a>
  
</div>
```

  </div>
</div>

<!-- === COMMUNITY === -->

<div style="padding: 2rem 1.5rem; background: #0d0221; border-top: 1px solid rgba(255,0,255,0.1);">
  <div style="max-width: 420px; margin: 0 auto;">

```
<div style="display: flex; flex-direction: column; gap: 10px;">
  
  <a href="https://www.linkedin.com/newsletters/flowstate-it%25E2%2580%2599s-probably-ok-7332189682052554753/" target="_blank" style="display: flex; align-items: center; gap: 14px; padding: 16px 18px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; text-decoration: none; color: #fff;">
    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, rgba(255,0,255,0.2), rgba(0,255,255,0.2)); border: 1px solid rgba(255,0,255,0.4); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#ff00ff" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
    </div>
    <div style="flex: 1;">
      <div style="font-family: 'Orbitron', sans-serif; font-size: 13px; font-weight: 600;">FLOWSTATE Newsletter</div>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: rgba(255,255,255,0.5);">co-creator · #2 non-corporate water newsletter · parody</div>
    </div>
    <span style="font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 700; color: #ff00ff; background: rgba(255,0,255,0.15); padding: 4px 8px; border-radius: 6px;">3.9K+</span>
  </a>
  
  <a href="https://www.linkedin.com/groups/42677/" target="_blank" style="display: flex; align-items: center; gap: 14px; padding: 16px 18px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; text-decoration: none; color: #fff;">
    <div style="width: 48px; height: 48px; background: rgba(0,255,255,0.1); border: 1px solid rgba(0,255,255,0.3); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#00ffff" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    </div>
    <div style="flex: 1;">
      <div style="font-family: 'Orbitron', sans-serif; font-size: 13px; font-weight: 600;">UCLA Alumni Network</div>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: rgba(255,255,255,0.5);">founder · largest unaffiliated</div>
    </div>
    <span style="font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 700; color: #00ffff; background: rgba(0,255,255,0.15); padding: 4px 8px; border-radius: 6px;">8K+</span>
  </a>
  
</div>
```

  </div>
</div>

<!-- === GAME LAUNCHER BUTTON === -->

<div style="padding: 2rem 1.5rem; background: linear-gradient(180deg, #0d0221, #1a0533); border-top: 1px solid rgba(255,0,255,0.15);">
  <div style="max-width: 420px; margin: 0 auto; text-align: center;">

```
<div style="font-family: 'JetBrains Mono', monospace; font-size: 9px; letter-spacing: 0.25em; text-transform: uppercase; color: rgba(255,255,255,0.3); margin-bottom: 12px;">.:: arcade ::.</div>

<style>
  @keyframes btnPulse {
    0%, 100% { box-shadow: 0 0 30px rgba(255,0,255,0.4), 0 8px 0 #880088, 0 0 0 0 rgba(255,0,255,0.4); }
    50% { box-shadow: 0 0 40px rgba(255,0,255,0.6), 0 8px 0 #880088, 0 0 0 8px rgba(255,0,255,0); }
  }
  @keyframes btnBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-3px); }
  }
  @keyframes btnPulse2 {
    0%, 100% { box-shadow: 0 0 25px rgba(0,255,136,0.3), 0 6px 0 #005522, 0 0 0 0 rgba(0,255,136,0.3); }
    50% { box-shadow: 0 0 35px rgba(0,255,136,0.5), 0 6px 0 #005522, 0 0 0 6px rgba(0,255,136,0); }
  }
  #launchGameBtn:hover, #launchFlowstateBtn:hover {
    transform: translateY(-2px);
  }
  #launchGameBtn:active, #launchFlowstateBtn:active {
    transform: translateY(4px);
  }
</style>

<div style="display: flex; flex-direction: column; gap: 14px;">
  
  <button id="launchGameBtn" style="display: inline-flex; align-items: center; justify-content: center; gap: 12px; padding: 18px 32px; background: linear-gradient(135deg, #ff00ff, #cc00cc); border: 2px solid #ff44ff; border-radius: 16px; color: #fff; font-family: 'Orbitron', sans-serif; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; box-shadow: 0 0 30px rgba(255,0,255,0.4), 0 8px 0 #880088; transition: all 0.15s ease; animation: btnPulse 2s ease-in-out infinite, btnBounce 3s ease-in-out infinite;">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M6 12h4M8 10v4"/><circle cx="17" cy="10" r="1" fill="currentColor"/><circle cx="17" cy="14" r="1" fill="currentColor"/></svg>
    Play PIPE PANIC
  </button>
  <div style="font-family: 'JetBrains Mono', monospace; font-size: 8px; color: rgba(255,255,255,0.25); margin-top: -8px;">puzzle · rotate pipes · race the clock</div>
  
  <button id="launchFlowstateBtn" style="display: inline-flex; align-items: center; justify-content: center; gap: 12px; padding: 16px 28px; background: linear-gradient(135deg, #00aa66, #008844); border: 2px solid #00ff88; border-radius: 16px; color: #fff; font-family: 'Orbitron', sans-serif; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; box-shadow: 0 0 25px rgba(0,255,136,0.3), 0 6px 0 #005522; transition: all 0.15s ease; animation: btnPulse2 2.5s ease-in-out infinite;">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/><path d="M15 11l2 2 4-4"/></svg>
    Play FLOWSTATE
  </button>
  <div style="font-family: 'JetBrains Mono', monospace; font-size: 8px; color: rgba(255,255,255,0.25); margin-top: -8px;">RPG · explore the plant · collect coins</div>
  
</div>
```

  </div>
</div>

<!-- === FOOTER === -->

<div style="padding: 2.5rem 1.5rem 3rem; background: linear-gradient(180deg, #0d0221 0%, #05010d 100%); text-align: center; position: relative; overflow: hidden;">

  <div class="orb1" style="position: absolute; bottom: -40%; left: 50%; transform: translateX(-50%); width: 400px; height: 250px; background: radial-gradient(ellipse, rgba(255,0,255,0.2) 0%, transparent 70%); pointer-events: none;"></div>

  <div style="max-width: 420px; margin: 0 auto; position: relative; z-index: 1;">

```
<div style="width: 60px; height: 2px; background: linear-gradient(90deg, #ff00ff, #00ffff); margin: 0 auto 1.5rem; border-radius: 2px;"></div>

<a href="https://calendly.com/bsaw" target="_blank" class="glow-border" style="display: inline-flex; align-items: center; gap: 10px; padding: 16px 28px; background: linear-gradient(135deg, #ff00ff, #cc00cc); color: #fff; font-family: 'Orbitron', sans-serif; font-size: 12px; font-weight: 600; text-decoration: none; text-transform: uppercase; letter-spacing: 0.1em; border-radius: 12px; border: none;">
  book the call
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
</a>

<div style="margin-top: 2rem;">
  <div class="glitch" style="font-family: 'Orbitron', sans-serif; font-size: 0.875rem; font-weight: 800; letter-spacing: 0.1em; text-transform: uppercase; color: #ff00ff;">watermaxxing.com</div>
  <div style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: rgba(255,255,255,0.2); margin-top: 8px; letter-spacing: 0.15em;">iykyk</div>
</div>
```

  </div>
</div>

</div>

<!-- ═══════════════════════════════════════════════════════════════════════════
     PIPE PANIC - ENHANCED WATER FLOW VERSION v2
═══════════════════════════════════════════════════════════════════════════ -->

<div id="gameOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,5,15,0.95); z-index: 1000; backdrop-filter: blur(10px);">

<button id="closeGameBtn" style="position: absolute; top: 16px; right: 16px; width: 44px; height: 44px; background: rgba(255,0,255,0.2); border: 2px solid rgba(255,0,255,0.4); border-radius: 50%; color: #ff00ff; font-size: 24px; cursor: pointer; z-index: 1002;">×</button>

  <div id="gameConsole" style="position: absolute; bottom: 0; left: 0; right: 0; transform: translateY(100%); transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 1001;">

```
<div style="max-width: 420px; margin: 0 auto; background: linear-gradient(180deg, #151530 0%, #0a0a1a 100%); border-radius: 30px 30px 0 0; padding: 16px 16px 24px; border: 3px solid #3a3a6a; border-bottom: none; box-shadow: 0 -15px 80px rgba(0,255,255,0.2), 0 -5px 40px rgba(255,0,255,0.2), inset 0 1px 0 rgba(255,255,255,0.1);">
  
  <div style="text-align: center; margin-bottom: 10px; position: relative;">
    <div style="font-family: 'Orbitron', sans-serif; font-size: 16px; font-weight: 900; letter-spacing: 0.15em; color: #00ffff; text-shadow: 0 0 20px #00ffff, 0 0 40px #00ffff;">PIPE PANIC</div>
    <div style="font-family: 'JetBrains Mono', monospace; font-size: 8px; color: rgba(255,255,255,0.3); margin-top: 2px; letter-spacing: 0.3em;">WATER EDITION</div>
  </div>
  
  <div style="background: #000; border-radius: 16px; padding: 4px; border: 3px solid #2a2a5a; box-shadow: inset 0 0 50px rgba(0,0,0,0.9), 0 0 20px rgba(0,255,255,0.1);">
    
    <div id="gameScreen" style="position: relative; width: 100%; height: 340px; background: linear-gradient(180deg, #000510 0%, #001020 50%, #000815 100%); border-radius: 12px; overflow: hidden;">
      
      <canvas id="gameCanvas" width="388" height="340" style="display: block; width: 100%; height: 100%; position: relative; z-index: 10;"></canvas>
      
      <!-- Start Screen -->
      <div id="startScreen" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(ellipse at center, rgba(0,30,60,0.98) 0%, rgba(0,10,30,0.99) 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 60; padding: 15px;">
        
        <svg width="70" height="70" viewBox="0 0 70 70" style="margin-bottom: 12px;">
          <defs>
            <linearGradient id="pipeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#00ffff"/>
              <stop offset="100%" style="stop-color:#ff00ff"/>
            </linearGradient>
          </defs>
          <circle cx="35" cy="35" r="30" fill="none" stroke="url(#pipeGrad)" stroke-width="5" opacity="0.3"/>
          <circle cx="35" cy="35" r="30" fill="none" stroke="url(#pipeGrad)" stroke-width="5" stroke-dasharray="50 140" stroke-linecap="round">
            <animateTransform attributeName="transform" type="rotate" from="0 35 35" to="360 35 35" dur="2s" repeatCount="indefinite"/>
          </circle>
          <path d="M35 12 C35 12 20 30 20 40 C20 50 27 55 35 55 C43 55 50 50 50 40 C50 30 35 12 35 12 Z" fill="#00ffff" opacity="0.8"/>
        </svg>
        
        <div style="font-family: 'Orbitron', sans-serif; font-size: 26px; font-weight: 900; color: #00ffff; text-shadow: 0 0 30px #00ffff; margin-bottom: 6px;">PIPE PANIC</div>
        
        <div style="width: 80px; height: 2px; background: linear-gradient(90deg, transparent, #00ffff, #ff00ff, transparent); margin-bottom: 12px;"></div>
        
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: rgba(255,255,255,0.7); text-align: center; line-height: 1.7; margin-bottom: 14px;">
          Connect <span style="color: #00ff88;">IN</span> → <span style="color: #ff00ff;">OUT</span> before overflow!
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; justify-content: center;">
          <div style="text-align: center; padding: 6px 10px; background: rgba(0,255,255,0.1); border: 1px solid rgba(0,255,255,0.3); border-radius: 8px;">
            <div style="font-family: 'Orbitron', sans-serif; font-size: 11px; color: #00ffff; font-weight: bold;">A</div>
            <div style="font-family: 'JetBrains Mono', monospace; font-size: 8px; color: rgba(255,255,255,0.5);">Rotate ↻</div>
          </div>
          <div style="text-align: center; padding: 6px 10px; background: rgba(255,0,255,0.1); border: 1px solid rgba(255,0,255,0.3); border-radius: 8px;">
            <div style="font-family: 'Orbitron', sans-serif; font-size: 11px; color: #ff00ff; font-weight: bold;">B</div>
            <div style="font-family: 'JetBrains Mono', monospace; font-size: 8px; color: rgba(255,255,255,0.5);">Rotate ↺</div>
          </div>
          <div style="text-align: center; padding: 6px 10px; background: rgba(255,200,0,0.1); border: 1px solid rgba(255,200,0,0.3); border-radius: 8px;">
            <div style="font-family: 'Orbitron', sans-serif; font-size: 11px; color: #ffcc00; font-weight: bold;">HOLD B</div>
            <div style="font-family: 'JetBrains Mono', monospace; font-size: 8px; color: rgba(255,255,255,0.5);">Swap tiles</div>
          </div>
        </div>
        
        <div style="font-family: 'Orbitron', sans-serif; font-size: 14px; color: #ff00ff; text-shadow: 0 0 15px #ff00ff;">
          ▶ PRESS A TO START ◀
        </div>
      </div>
      
      <!-- Level Complete -->
      <div id="levelScreen" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(ellipse at center, rgba(0,50,40,0.98) 0%, rgba(0,20,15,0.99) 100%); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 60;">
        <div id="levelCelebration" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; overflow: hidden;"></div>
        <svg width="80" height="80" viewBox="0 0 80 80" style="margin-bottom: 8px; filter: drop-shadow(0 0 25px #00ff88);">
          <path d="M40 5 C40 5 15 35 15 50 C15 65 26 75 40 75 C54 75 65 65 65 50 C65 35 40 5 40 5 Z" fill="#00ffaa" stroke="#00ff88" stroke-width="3">
            <animate attributeName="d" dur="0.5s" values="M40 5 C40 5 15 35 15 50 C15 65 26 75 40 75 C54 75 65 65 65 50 C65 35 40 5 40 5 Z; M40 8 C40 8 18 35 18 48 C18 62 28 72 40 72 C52 72 62 62 62 48 C62 35 40 8 40 8 Z; M40 5 C40 5 15 35 15 50 C15 65 26 75 40 75 C54 75 65 65 65 50 C65 35 40 5 40 5 Z" repeatCount="indefinite"/>
          </path>
          <ellipse cx="30" cy="45" rx="8" ry="12" fill="rgba(255,255,255,0.4)"/>
          <path d="M30 60 L35 55 L40 62 L50 45" fill="none" stroke="#fff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div style="font-family: 'Orbitron', sans-serif; font-size: 28px; font-weight: 800; color: #00ff88; text-shadow: 0 0 30px #00ff88; margin-bottom: 8px;">CONNECTED!</div>
        <div id="levelBonus" style="font-family: 'JetBrains Mono', monospace; font-size: 16px; color: #00ffff; margin-bottom: 6px;"></div>
        <div id="levelTotal" style="font-family: 'JetBrains Mono', monospace; font-size: 14px; color: #fff; margin-bottom: 12px;"></div>
        
        <!-- Barron appears -->
        <div style="display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.4); padding: 10px 16px; border-radius: 12px; border: 1px solid rgba(0,255,255,0.3); margin-bottom: 12px;">
          <img src="https://ugc.production.linktr.ee/5dad016f-c443-42e7-8c23-c6d49785ae72_IMG-0940.jpeg" style="width: 36px; height: 36px; border-radius: 50%; border: 2px solid #00ffff; object-fit: cover;">
          <div>
            <div style="font-family: 'Orbitron', sans-serif; font-size: 10px; color: #00ffff;">BARRON SAYS:</div>
            <div style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: rgba(255,255,255,0.8);">"Nice flow! Keep it up!"</div>
          </div>
        </div>
        
        <div style="font-family: 'Orbitron', sans-serif; font-size: 13px; color: #ff00ff;">▶ PRESS A ◀</div>
      </div>
      
      <!-- Game Over -->
      <div id="gameOverScreen" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(ellipse at center, rgba(50,0,20,0.98) 0%, rgba(20,0,10,0.99) 100%); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 60;">
        <svg width="80" height="80" viewBox="0 0 80 80" style="margin-bottom: 8px; filter: drop-shadow(0 0 20px #ff0055);">
          <path d="M5 45 Q20 30 35 45 T65 45 T95 45" fill="none" stroke="#ff0055" stroke-width="7" stroke-linecap="round">
            <animate attributeName="d" dur="0.8s" values="M5 45 Q20 30 35 45 T65 45; M5 45 Q20 55 35 45 T65 45; M5 45 Q20 30 35 45 T65 45" repeatCount="indefinite"/>
          </path>
          <path d="M5 55 Q20 42 35 55 T65 55 T95 55" fill="none" stroke="#ff3366" stroke-width="5" stroke-linecap="round"/>
          <path d="M5 63 Q20 52 35 63 T65 63" fill="none" stroke="#ff6688" stroke-width="4" stroke-linecap="round"/>
          <circle cx="25" cy="28" r="5" fill="#ff0055"><animate attributeName="cy" dur="1s" values="28;20;28" repeatCount="indefinite"/></circle>
          <circle cx="55" cy="22" r="4" fill="#ff3366"><animate attributeName="cy" dur="0.8s" values="22;15;22" repeatCount="indefinite"/></circle>
          <circle cx="40" cy="18" r="6" fill="#ff0055"><animate attributeName="cy" dur="1.2s" values="18;10;18" repeatCount="indefinite"/></circle>
        </svg>
        <div style="font-family: 'Orbitron', sans-serif; font-size: 28px; font-weight: 800; color: #ff0055; text-shadow: 0 0 30px #ff0055; margin-bottom: 8px;">OVERFLOW!</div>
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 18px; color: #00ffff; margin-bottom: 6px;">SCORE: <span id="finalScore">0</span></div>
        <div id="highScoreText" style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #00ff88; margin-bottom: 12px;"></div>
        
        <!-- Barron appears -->
        <div style="display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.4); padding: 10px 16px; border-radius: 12px; border: 1px solid rgba(255,0,255,0.3); margin-bottom: 12px;">
          <img src="https://ugc.production.linktr.ee/5dad016f-c443-42e7-8c23-c6d49785ae72_IMG-0940.jpeg" style="width: 36px; height: 36px; border-radius: 50%; border: 2px solid #ff00ff; object-fit: cover;">
          <div>
            <div style="font-family: 'Orbitron', sans-serif; font-size: 10px; color: #ff00ff;">BARRON SAYS:</div>
            <div style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: rgba(255,255,255,0.8);">"Follow me on LinkedIn for tips!"</div>
          </div>
        </div>
        
        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
          <a href="https://www.linkedin.com/in/sawyerlaw/" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background: rgba(0,119,181,0.3); border: 1px solid #0077b5; border-radius: 8px; color: #fff; text-decoration: none; font-family: 'JetBrains Mono', monospace; font-size: 9px;">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="#0077b5"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/></svg>
            Follow
          </a>
          <button onclick="shareGame()" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background: rgba(0,255,136,0.2); border: 1px solid #00ff88; border-radius: 8px; color: #fff; font-family: 'JetBrains Mono', monospace; font-size: 9px; cursor: pointer;">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#00ff88" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="M8.59 13.51l6.83 3.98M15.41 6.51l-6.82 3.98"/></svg>
            Share Game
          </button>
        </div>
        
        <div style="font-family: 'Orbitron', sans-serif; font-size: 13px; color: rgba(255,255,255,0.6);">▶ PRESS A TO RESTART ◀</div>
      </div>
      
      <!-- Victory -->
      <div id="victoryScreen" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(ellipse at center, rgba(0,50,50,0.98) 0%, rgba(0,20,30,0.99) 100%); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 60;">
        <div id="victoryCelebration" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; overflow: hidden;"></div>
        <svg width="80" height="80" viewBox="0 0 80 80" style="margin-bottom: 8px; filter: drop-shadow(0 0 25px #ffcc00);">
          <path d="M25 18 L25 40 Q25 55 40 60 Q55 55 55 40 L55 18 Z" fill="#ffcc00" stroke="#ffaa00" stroke-width="3">
            <animate attributeName="d" dur="0.6s" values="M25 18 L25 40 Q25 55 40 60 Q55 55 55 40 L55 18 Z; M23 16 L23 42 Q23 57 40 62 Q57 57 57 42 L57 16 Z; M25 18 L25 40 Q25 55 40 60 Q55 55 55 40 L55 18 Z" repeatCount="indefinite"/>
          </path>
          <path d="M18 18 L12 18 Q6 18 6 30 Q6 42 18 42 L25 42" fill="none" stroke="#ffcc00" stroke-width="5"/>
          <path d="M62 18 L68 18 Q74 18 74 30 Q74 42 62 42 L55 42" fill="none" stroke="#ffcc00" stroke-width="5"/>
          <rect x="32" y="60" width="16" height="8" fill="#ffaa00"/>
          <rect x="26" y="68" width="28" height="6" rx="2" fill="#ffcc00"/>
          <text x="40" y="45" text-anchor="middle" fill="#fff" font-family="Arial" font-size="18" font-weight="bold">1</text>
        </svg>
        <div style="font-family: 'Orbitron', sans-serif; font-size: 24px; font-weight: 800; color: #00ff88; text-shadow: 0 0 30px #00ff88; margin-bottom: 6px;">MASTER OPERATOR!</div>
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 14px; color: #00ffff; margin-bottom: 4px;">ALL LEVELS COMPLETE!</div>
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 20px; color: #ff00ff; margin-bottom: 12px;">SCORE: <span id="victoryScore">0</span></div>
        
        <!-- Barron appears -->
        <div style="display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.4); padding: 10px 16px; border-radius: 12px; border: 1px solid rgba(0,255,136,0.4); margin-bottom: 12px;">
          <img src="https://ugc.production.linktr.ee/5dad016f-c443-42e7-8c23-c6d49785ae72_IMG-0940.jpeg" style="width: 36px; height: 36px; border-radius: 50%; border: 2px solid #00ff88; object-fit: cover;">
          <div>
            <div style="font-family: 'Orbitron', sans-serif; font-size: 10px; color: #00ff88;">BARRON SAYS:</div>
            <div style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: rgba(255,255,255,0.8);">"You're a natural! Let's connect!"</div>
          </div>
        </div>
        
        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
          <a href="https://www.linkedin.com/in/sawyerlaw/" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background: rgba(0,119,181,0.3); border: 1px solid #0077b5; border-radius: 8px; color: #fff; text-decoration: none; font-family: 'JetBrains Mono', monospace; font-size: 9px;">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="#0077b5"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/></svg>
            Follow
          </a>
          <button onclick="shareGame()" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background: rgba(0,255,136,0.2); border: 1px solid #00ff88; border-radius: 8px; color: #fff; font-family: 'JetBrains Mono', monospace; font-size: 9px; cursor: pointer;">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#00ff88" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="M8.59 13.51l6.83 3.98M15.41 6.51l-6.82 3.98"/></svg>
            Share Game
          </button>
        </div>
        
        <div style="font-family: 'Orbitron', sans-serif; font-size: 12px; color: rgba(255,255,255,0.6);">▶ PRESS A TO PLAY AGAIN ◀</div>
      </div>
      
    </div>
  </div>
  
  <!-- Controls -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 14px; padding: 0 6px;">
    
    <div style="position: relative; width: 110px; height: 110px;">
      <button id="btnUp" style="position: absolute; left: 50%; top: 0; transform: translateX(-50%); width: 38px; height: 38px; background: linear-gradient(180deg, #5a5a8a, #3a3a6a); border: 3px solid #6a6a9a; border-radius: 50%; color: #00ffff; font-size: 14px; cursor: pointer; box-shadow: 0 4px 0 #2a2a4a, 0 0 12px rgba(0,255,255,0.3), inset 0 2px 0 rgba(255,255,255,0.2); transition: all 0.1s; -webkit-tap-highlight-color: transparent;">▲</button>
      <button id="btnDown" style="position: absolute; left: 50%; bottom: 0; transform: translateX(-50%); width: 38px; height: 38px; background: linear-gradient(180deg, #5a5a8a, #3a3a6a); border: 3px solid #6a6a9a; border-radius: 50%; color: #00ffff; font-size: 14px; cursor: pointer; box-shadow: 0 4px 0 #2a2a4a, 0 0 12px rgba(0,255,255,0.3), inset 0 2px 0 rgba(255,255,255,0.2); transition: all 0.1s; -webkit-tap-highlight-color: transparent;">▼</button>
      <button id="btnLeft" style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 38px; height: 38px; background: linear-gradient(180deg, #5a5a8a, #3a3a6a); border: 3px solid #6a6a9a; border-radius: 50%; color: #00ffff; font-size: 14px; cursor: pointer; box-shadow: 0 4px 0 #2a2a4a, 0 0 12px rgba(0,255,255,0.3), inset 0 2px 0 rgba(255,255,255,0.2); transition: all 0.1s; -webkit-tap-highlight-color: transparent;">◀</button>
      <button id="btnRight" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); width: 38px; height: 38px; background: linear-gradient(180deg, #5a5a8a, #3a3a6a); border: 3px solid #6a6a9a; border-radius: 50%; color: #00ffff; font-size: 14px; cursor: pointer; box-shadow: 0 4px 0 #2a2a4a, 0 0 12px rgba(0,255,255,0.3), inset 0 2px 0 rgba(255,255,255,0.2); transition: all 0.1s; -webkit-tap-highlight-color: transparent;">▶</button>
      <div style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 24px; height: 24px; background: radial-gradient(circle, #3a3a6a, #2a2a4a); border-radius: 50%; border: 2px solid #4a4a7a; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);"></div>
    </div>
    
    <div style="text-align: center;">
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 5px; color: rgba(255,255,255,0.12); letter-spacing: 0.15em;">WATERMAXXING</div>
    </div>
    
    <div style="display: flex; gap: 14px;">
      <div style="text-align: center;">
        <button id="btnB" style="width: 52px; height: 52px; background: linear-gradient(180deg, #ff00ff, #cc00cc); border: 3px solid #ff66ff; border-radius: 50%; color: #fff; font-family: 'Orbitron', sans-serif; font-size: 18px; font-weight: 800; cursor: pointer; box-shadow: 0 5px 0 #880088, 0 0 25px rgba(255,0,255,0.5); -webkit-tap-highlight-color: transparent;">B</button>
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 8px; color: #ff00ff; margin-top: 4px;">↺</div>
      </div>
      <div style="text-align: center;">
        <button id="btnA" style="width: 52px; height: 52px; background: linear-gradient(180deg, #00ffff, #00cccc); border: 3px solid #66ffff; border-radius: 50%; color: #003333; font-family: 'Orbitron', sans-serif; font-size: 18px; font-weight: 800; cursor: pointer; box-shadow: 0 5px 0 #008888, 0 0 25px rgba(0,255,255,0.5); -webkit-tap-highlight-color: transparent;">A</button>
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 8px; color: #00ffff; margin-top: 4px;">↻</div>
      </div>
    </div>
    
  </div>
  
</div>
```

  </div>
</div>

<script>
// Share game function (outside IIFE so onclick can access it)
let currentGameScore = 0; // Will be set by game

function shareGame() {
  const shareText = `🕹️ Just played Pipe Panic on Barron's business card - a retro puzzle game! Can you beat my score: ${currentGameScore}? 💧`;
  const shareUrl = "https://watermaxxing.com";
  
  // Try native share first (mobile)
  if (navigator.share) {
    navigator.share({
      title: 'PIPE PANIC',
      text: shareText,
      url: shareUrl
    }).catch(() => {
      // Fallback to SMS
      window.open(`sms:?body=${encodeURIComponent(shareText + ' ' + shareUrl)}`);
    });
  } else {
    // Desktop fallback - open SMS link or copy to clipboard
    const fullText = shareText + ' ' + shareUrl;
    if (navigator.clipboard) {
      navigator.clipboard.writeText(fullText).then(() => {
        alert('Link copied! Share it with your friends.');
      });
    } else {
      window.open(`sms:?body=${encodeURIComponent(fullText)}`);
    }
  }
}
</script>

<script>
(function() {
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  
  const overlay = document.getElementById('gameOverlay');
  const consoleEl = document.getElementById('gameConsole');
  
  const screens = {
    start: document.getElementById('startScreen'),
    level: document.getElementById('levelScreen'),
    over: document.getElementById('gameOverScreen'),
    victory: document.getElementById('victoryScreen')
  };
  
  // Game state
  let state = 'menu';
  let level = 1;
  let score = 0;
  let highScore = 0;
  let grid = [];
  let solutionGrid = []; // Store the solution
  let cols = 3, rows = 3;
  let cursorX = 0, cursorY = 0;
  let sourceY = 1, drainY = 1;
  let flowPath = [];
  let animTime = 0;
  let particles = [];
  let waterProgress = 0; // 0-100%, how far water has flowed
  let waterSpeed = 2; // % per frame
  let waterStartDelay = 3; // seconds before water starts
  let gameStartTime = 0;
  let swapMode = false;
  let swapStartX = -1, swapStartY = -1;
  let btnADown = false, btnBDown = false;
  let celebrationParticles = [];
  
  const levels = [
    { cols: 3, rows: 3, waterDelay: 5, waterSpeed: 0.15 },
    { cols: 4, rows: 3, waterDelay: 5, waterSpeed: 0.18 },
    { cols: 4, rows: 4, waterDelay: 5, waterSpeed: 0.20 }
  ];
  
  const CELL = 58;
  const PIPE_W = 16;
  
  function showGame() {
    overlay.style.display = 'block';
    setTimeout(() => consoleEl.style.transform = 'translateY(0)', 20);
    lastTime = performance.now();
    requestAnimationFrame(gameLoop);
  }
  
  function hideGame() {
    consoleEl.style.transform = 'translateY(100%)';
    setTimeout(() => overlay.style.display = 'none', 400);
  }
  
  document.getElementById('launchGameBtn').onclick = showGame;
  document.getElementById('closeGameBtn').onclick = hideGame;
  overlay.onclick = e => { if (e.target === overlay) hideGame(); };
  
  function rotateCW(c) { return [c[3], c[0], c[1], c[2]]; }
  function rotateCCW(c) { return [c[1], c[2], c[3], c[0]]; }
  
  function generateLevel() {
    const cfg = levels[level - 1];
    cols = cfg.cols;
    rows = cfg.rows;
    waterStartDelay = cfg.waterDelay;
    waterSpeed = cfg.waterSpeed;
    waterProgress = 0;
    particles = [];
    celebrationParticles = [];
    gameStartTime = performance.now();
    
    // Generate source and drain positions
    sourceY = Math.floor(Math.random() * rows);
    drainY = Math.floor(Math.random() * rows);
    
    // GENERATE A GUARANTEED SOLVABLE PUZZLE
    // First, create the solution grid
    solutionGrid = [];
    for (let y = 0; y < rows; y++) {
      solutionGrid[y] = [];
      for (let x = 0; x < cols; x++) {
        solutionGrid[y][x] = { c: [0,0,0,0] };
      }
    }
    
    // Build path from source to drain
    let x = 0, y = sourceY;
    let path = [{x, y}];
    
    while (x < cols - 1 || y !== drainY) {
      let nextX = x, nextY = y;
      
      // Decide next move
      if (x < cols - 1) {
        if (y < drainY && Math.random() < 0.4) {
          nextY = y + 1; // go down
        } else if (y > drainY && Math.random() < 0.4) {
          nextY = y - 1; // go up
        } else {
          nextX = x + 1; // go right
        }
      } else {
        // Must reach drain row
        if (y < drainY) nextY = y + 1;
        else if (y > drainY) nextY = y - 1;
      }
      
      // Set connections
      if (nextX > x) { // going right
        solutionGrid[y][x].c[1] = 1;
        solutionGrid[nextY][nextX].c[3] = 1;
      } else if (nextY > y) { // going down
        solutionGrid[y][x].c[2] = 1;
        solutionGrid[nextY][nextX].c[0] = 1;
      } else if (nextY < y) { // going up
        solutionGrid[y][x].c[0] = 1;
        solutionGrid[nextY][nextX].c[2] = 1;
      }
      
      x = nextX;
      y = nextY;
      path.push({x, y});
    }
    
    // Add source and drain connections
    solutionGrid[sourceY][0].c[3] = 1; // connect to source
    solutionGrid[drainY][cols-1].c[1] = 1; // connect to drain
    
    // Create playable grid by scrambling the solution
    grid = [];
    for (let gy = 0; gy < rows; gy++) {
      grid[gy] = [];
      for (let gx = 0; gx < cols; gx++) {
        let c = [...solutionGrid[gy][gx].c];
        
        // Scramble with random rotations (1-3)
        const rots = 1 + Math.floor(Math.random() * 3);
        for (let r = 0; r < rots; r++) {
          c = rotateCW(c);
        }
        
        grid[gy][gx] = { c };
      }
    }
    
    cursorX = 0;
    cursorY = sourceY;
    swapMode = false;
    swapStartX = -1;
    swapStartY = -1;
    
    checkFlow();
  }
  
  function checkFlow() {
    flowPath = [];
    let x = 0, y = sourceY, fromDir = 3;
    const visited = new Set();
    
    while (x >= 0 && x < cols && y >= 0 && y < rows) {
      const key = `${x},${y}`;
      if (visited.has(key)) break;
      visited.add(key);
      
      const cell = grid[y][x];
      if (cell.c[fromDir] !== 1) break;
      
      flowPath.push({x, y});
      
      let exitDir = -1;
      for (let d = 0; d < 4; d++) {
        if (d !== fromDir && cell.c[d] === 1) { exitDir = d; break; }
      }
      if (exitDir === -1) break;
      
      if (x === cols - 1 && y === drainY && exitDir === 1) {
        flowPath.push({x: cols, y: drainY}); // Mark complete
        return true;
      }
      
      const moves = [{dx:0,dy:-1,e:2}, {dx:1,dy:0,e:3}, {dx:0,dy:1,e:0}, {dx:-1,dy:0,e:1}];
      x += moves[exitDir].dx;
      y += moves[exitDir].dy;
      fromDir = moves[exitDir].e;
    }
    return false;
  }
  
  function rotateTile(clockwise) {
    if (state !== 'playing') return;
    if (swapMode) return; // Can't rotate in swap mode
    
    const cell = grid[cursorY][cursorX];
    cell.c = clockwise ? rotateCW(cell.c) : rotateCCW(cell.c);
    
    // Particles
    const offset = getGridOffset();
    const cx = offset.x + cursorX * (CELL + 4) + CELL/2;
    const cy = offset.y + cursorY * (CELL + 4) + CELL/2;
    for (let i = 0; i < 4; i++) {
      particles.push({
        x: cx, y: cy,
        vx: (Math.random() - 0.5) * 5,
        vy: (Math.random() - 0.5) * 5,
        life: 15,
        color: clockwise ? '#00ffff' : '#ff00ff',
        size: 2 + Math.random() * 3
      });
    }
    
    if (checkFlow()) {
      setTimeout(levelComplete, 200);
    }
  }
  
  function startSwap() {
    if (state !== 'playing') return;
    swapMode = true;
    swapStartX = cursorX;
    swapStartY = cursorY;
  }
  
  function executeSwap() {
    if (!swapMode || swapStartX === -1) return;
    
    // Swap the two tiles
    if (swapStartX !== cursorX || swapStartY !== cursorY) {
      const temp = {...grid[swapStartY][swapStartX]};
      grid[swapStartY][swapStartX] = {...grid[cursorY][cursorX]};
      grid[cursorY][cursorX] = temp;
      
      // Swap particles
      const offset = getGridOffset();
      for (let i = 0; i < 8; i++) {
        const cx1 = offset.x + swapStartX * (CELL + 4) + CELL/2;
        const cy1 = offset.y + swapStartY * (CELL + 4) + CELL/2;
        const cx2 = offset.x + cursorX * (CELL + 4) + CELL/2;
        const cy2 = offset.y + cursorY * (CELL + 4) + CELL/2;
        particles.push({
          x: cx1, y: cy1, vx: (cx2-cx1)/10, vy: (cy2-cy1)/10,
          life: 10, color: '#ffcc00', size: 4
        });
      }
      
      if (checkFlow()) {
        setTimeout(levelComplete, 200);
      }
    }
    
    swapMode = false;
    swapStartX = -1;
    swapStartY = -1;
  }
  
  function cancelSwap() {
    swapMode = false;
    swapStartX = -1;
    swapStartY = -1;
  }
  
  function moveCursor(dx, dy) {
    if (state !== 'playing') return;
    cursorX = Math.max(0, Math.min(cols - 1, cursorX + dx));
    cursorY = Math.max(0, Math.min(rows - 1, cursorY + dy));
  }
  
  function getGridOffset() {
    const gw = cols * CELL + (cols - 1) * 4;
    const gh = rows * CELL + (rows - 1) * 4;
    return {
      x: (W - gw) / 2,
      y: 50 + (H - 60 - gh) / 2
    };
  }
  
  function drawPipe(cx, cy, cell, inFlow, flowAmount) {
    const c = cell.c;
    
    ctx.save();
    ctx.translate(cx, cy);
    
    const baseColor = inFlow ? '#00ddff' : '#335577';
    
    if (inFlow && flowAmount > 0) {
      ctx.shadowColor = '#00ffff';
      ctx.shadowBlur = 12;
    }
    
    ctx.strokeStyle = baseColor;
    ctx.lineWidth = PIPE_W;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    ctx.beginPath();
    if (c[0]) { ctx.moveTo(0, 0); ctx.lineTo(0, -CELL/2); }
    if (c[1]) { ctx.moveTo(0, 0); ctx.lineTo(CELL/2, 0); }
    if (c[2]) { ctx.moveTo(0, 0); ctx.lineTo(0, CELL/2); }
    if (c[3]) { ctx.moveTo(0, 0); ctx.lineTo(-CELL/2, 0); }
    ctx.stroke();
    
    ctx.fillStyle = baseColor;
    ctx.beginPath();
    ctx.arc(0, 0, PIPE_W/2, 0, Math.PI * 2);
    ctx.fill();
    
    // Water flow animation
    if (inFlow && flowAmount > 0) {
      ctx.strokeStyle = `rgba(100,255,255,${0.5 + Math.sin(animTime * 6) * 0.3})`;
      ctx.lineWidth = 6;
      ctx.setLineDash([6, 10]);
      ctx.lineDashOffset = -animTime * 100;
      ctx.beginPath();
      if (c[0]) { ctx.moveTo(0, 0); ctx.lineTo(0, -CELL/2); }
      if (c[1]) { ctx.moveTo(0, 0); ctx.lineTo(CELL/2, 0); }
      if (c[2]) { ctx.moveTo(0, 0); ctx.lineTo(0, CELL/2); }
      if (c[3]) { ctx.moveTo(0, 0); ctx.lineTo(-CELL/2, 0); }
      ctx.stroke();
      ctx.setLineDash([]);
    }
    
    ctx.restore();
  }
  
  let lastTime = 0;
  
  function gameLoop(time) {
    if (overlay.style.display === 'none') return;
    
    const dt = Math.min((time - lastTime) / 1000, 0.1);
    lastTime = time;
    animTime += dt;
    
    if (state === 'playing') {
      const elapsed = (time - gameStartTime) / 1000;
      
      // Water starts flowing after delay
      if (elapsed > waterStartDelay) {
        waterProgress += waterSpeed * dt * 100 / (flowPath.length || 1);
        
        // Check if water hit a dead end (not complete)
        const isComplete = flowPath.length > 0 && flowPath[flowPath.length-1].x === cols;
        
        if (waterProgress >= 100 && !isComplete) {
          gameOver();
          return;
        }
      }
    }
    
    // Update particles
    particles = particles.filter(p => {
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.15;
      p.life--;
      return p.life > 0;
    });
    
    draw();
    requestAnimationFrame(gameLoop);
  }
  
  function draw() {
    // Background
    const grad = ctx.createLinearGradient(0, 0, 0, H);
    grad.addColorStop(0, '#000a18');
    grad.addColorStop(0.5, '#001228');
    grad.addColorStop(1, '#000815');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, W, H);
    
    // Grid lines
    ctx.strokeStyle = 'rgba(0,150,200,0.04)';
    ctx.lineWidth = 1;
    for (let i = 0; i <= W; i += 25) {
      ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, H); ctx.stroke();
    }
    for (let i = 0; i <= H; i += 25) {
      ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(W, i); ctx.stroke();
    }
    
    if (state === 'menu') return;
    
    // HUD
    ctx.font = 'bold 15px Orbitron';
    ctx.fillStyle = '#00ffff';
    ctx.textAlign = 'left';
    ctx.fillText('LEVEL ' + level, 12, 26);
    
    ctx.fillStyle = '#fff';
    ctx.textAlign = 'right';
    ctx.fillText(score, W - 12, 26);
    
    // Water progress bar (the timer)
    const elapsed = (performance.now() - gameStartTime) / 1000;
    const barW = 140;
    const barX = (W - barW) / 2;
    
    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.fillRect(barX - 2, 8, barW + 4, 20);
    
    if (elapsed < waterStartDelay) {
      // Countdown before water
      const countdown = Math.ceil(waterStartDelay - elapsed);
      ctx.fillStyle = '#00ff88';
      ctx.fillRect(barX, 10, barW, 16);
      ctx.fillStyle = '#003322';
      ctx.font = 'bold 11px Orbitron';
      ctx.textAlign = 'center';
      ctx.fillText('WATER IN ' + countdown + 's', W/2, 22);
    } else {
      // Water flowing
      const pct = Math.min(waterProgress / 100, 1);
      const barColor = pct < 0.5 ? '#00ffff' : pct < 0.75 ? '#ffaa00' : '#ff0044';
      ctx.fillStyle = barColor;
      ctx.fillRect(barX, 10, barW * pct, 16);
      ctx.strokeStyle = barColor;
      ctx.lineWidth = 2;
      ctx.strokeRect(barX - 2, 8, barW + 4, 20);
    }
    
    const offset = getGridOffset();
    
    // Source pipe
    const srcY = offset.y + sourceY * (CELL + 4) + CELL/2;
    ctx.fillStyle = '#00ff88';
    ctx.shadowColor = '#00ff88';
    ctx.shadowBlur = 12;
    ctx.beginPath();
    ctx.moveTo(offset.x - 22, srcY);
    ctx.lineTo(offset.x - 6, srcY - 10);
    ctx.lineTo(offset.x - 6, srcY + 10);
    ctx.closePath();
    ctx.fill();
    ctx.shadowBlur = 0;
    
    ctx.strokeStyle = '#00ff88';
    ctx.lineWidth = PIPE_W;
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(offset.x - 30, srcY);
    ctx.lineTo(offset.x - 4, srcY);
    ctx.stroke();
    
    ctx.font = 'bold 9px Orbitron';
    ctx.fillStyle = '#00ff88';
    ctx.textAlign = 'right';
    ctx.fillText('IN', offset.x - 34, srcY + 3);
    
    // Drain pipe
    const drnY = offset.y + drainY * (CELL + 4) + CELL/2;
    const gridRight = offset.x + cols * (CELL + 4) - 4;
    
    ctx.fillStyle = '#ff00ff';
    ctx.shadowColor = '#ff00ff';
    ctx.shadowBlur = 12;
    ctx.beginPath();
    ctx.moveTo(gridRight + 22, drnY);
    ctx.lineTo(gridRight + 6, drnY - 10);
    ctx.lineTo(gridRight + 6, drnY + 10);
    ctx.closePath();
    ctx.fill();
    ctx.shadowBlur = 0;
    
    ctx.strokeStyle = '#ff00ff';
    ctx.lineWidth = PIPE_W;
    ctx.beginPath();
    ctx.moveTo(gridRight + 4, drnY);
    ctx.lineTo(gridRight + 30, drnY);
    ctx.stroke();
    
    ctx.fillStyle = '#ff00ff';
    ctx.textAlign = 'left';
    ctx.fillText('OUT', gridRight + 34, drnY + 3);
    
    // Draw grid cells
    for (let y = 0; y < rows; y++) {
      for (let x = 0; x < cols; x++) {
        const cell = grid[y][x];
        const cx = offset.x + x * (CELL + 4) + CELL/2;
        const cy = offset.y + y * (CELL + 4) + CELL/2;
        
        const flowIdx = flowPath.findIndex(f => f.x === x && f.y === y);
        const inFlow = flowIdx !== -1;
        const flowAmount = inFlow ? Math.max(0, Math.min(1, (waterProgress - flowIdx * (100/flowPath.length)) / (100/flowPath.length))) : 0;
        
        const isSelected = x === cursorX && y === cursorY;
        const isSwapStart = swapMode && x === swapStartX && y === swapStartY;
        
        // Cell background
        let bgColor = 'rgba(0,40,70,0.5)';
        if (inFlow && flowAmount > 0) bgColor = 'rgba(0,80,100,0.5)';
        if (isSwapStart) bgColor = 'rgba(255,200,0,0.3)';
        if (isSelected) bgColor = swapMode ? 'rgba(255,200,0,0.4)' : 'rgba(150,0,150,0.4)';
        
        ctx.fillStyle = bgColor;
        ctx.beginPath();
        ctx.roundRect(cx - CELL/2, cy - CELL/2, CELL, CELL, 6);
        ctx.fill();
        
        // Selection border
        if (isSelected || isSwapStart) {
          ctx.strokeStyle = swapMode ? '#ffcc00' : '#ff00ff';
          ctx.lineWidth = 3;
          ctx.shadowColor = swapMode ? '#ffcc00' : '#ff00ff';
          ctx.shadowBlur = 15;
          ctx.stroke();
          ctx.shadowBlur = 0;
        } else {
          ctx.strokeStyle = inFlow ? 'rgba(0,255,255,0.25)' : 'rgba(100,150,200,0.15)';
          ctx.lineWidth = 1;
          ctx.stroke();
        }
        
        drawPipe(cx, cy, cell, inFlow, flowAmount);
      }
    }
    
    // Swap mode indicator
    if (swapMode) {
      ctx.font = 'bold 10px Orbitron';
      ctx.fillStyle = '#ffcc00';
      ctx.textAlign = 'center';
      ctx.fillText('SWAP: Move cursor, press A to swap', W/2, H - 15);
    }
    
    // Particles
    for (const p of particles) {
      ctx.fillStyle = p.color;
      ctx.globalAlpha = p.life / 15;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;
  }
  
  function createCelebration(container) {
    container.innerHTML = '';
    for (let i = 0; i < 30; i++) {
      const particle = document.createElement('div');
      const colors = ['#00ffff', '#ff00ff', '#00ff88', '#ffcc00', '#ff6688'];
      particle.style.cssText = `
        position: absolute;
        width: ${4 + Math.random() * 8}px;
        height: ${4 + Math.random() * 8}px;
        background: ${colors[Math.floor(Math.random() * colors.length)]};
        border-radius: 50%;
        left: ${Math.random() * 100}%;
        top: 100%;
        animation: celebrate ${1 + Math.random()}s ease-out forwards;
        animation-delay: ${Math.random() * 0.3}s;
      `;
      container.appendChild(particle);
    }
    
    // Add CSS animation if not exists
    if (!document.getElementById('celebrateStyle')) {
      const style = document.createElement('style');
      style.id = 'celebrateStyle';
      style.textContent = `
        @keyframes celebrate {
          0% { transform: translateY(0) rotate(0deg); opacity: 1; }
          100% { transform: translateY(-300px) rotate(720deg); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
    }
  }
  
  function hideScreens() {
    Object.values(screens).forEach(s => s.style.display = 'none');
  }
  
  function startGame() {
    level = 1;
    score = 0;
    state = 'playing';
    hideScreens();
    generateLevel();
  }
  
  function levelComplete() {
    state = 'levelComplete';
    
    const timeBonus = Math.max(0, Math.floor((100 - waterProgress) * 10));
    const levelBonus = level * 200;
    const total = timeBonus + levelBonus;
    score += total;
    
    document.getElementById('levelBonus').textContent = `SPEED +${timeBonus}  •  LEVEL +${levelBonus}`;
    document.getElementById('levelTotal').textContent = `TOTAL: ${score}`;
    
    // Create celebration
    createCelebration(document.getElementById('levelCelebration'));
    
    screens.level.style.display = 'flex';
  }
  
  function nextLevel() {
    level++;
    if (level > 3) {
      victory();
      return;
    }
    state = 'playing';
    hideScreens();
    generateLevel();
  }
  
  function gameOver() {
    state = 'gameOver';
    currentGameScore = score; // For share function
    document.getElementById('finalScore').textContent = score;
    document.getElementById('highScoreText').textContent = score > highScore ? '★ NEW HIGH SCORE! ★' : `BEST: ${highScore}`;
    if (score > highScore) highScore = score;
    screens.over.style.display = 'flex';
  }
  
  function victory() {
    state = 'victory';
    currentGameScore = score; // For share function
    document.getElementById('victoryScore').textContent = score;
    if (score > highScore) highScore = score;
    createCelebration(document.getElementById('victoryCelebration'));
    screens.victory.style.display = 'flex';
  }
  
  function handleA() {
    if (state === 'menu' || state === 'gameOver' || state === 'victory') startGame();
    else if (state === 'levelComplete') nextLevel();
    else if (state === 'playing') {
      if (swapMode) {
        // In swap mode, A confirms the swap
        executeSwap();
      } else {
        rotateTile(true);
      }
    }
  }
  
  function handleB() {
    if (state === 'playing') {
      if (swapMode) {
        // Already in swap mode - cancel it
        cancelSwap();
      } else {
        rotateTile(false);
      }
    } else {
      handleA();
    }
  }
  
  function handleBHold() {
    // Long press B enters swap mode
    if (state === 'playing' && !swapMode) {
      startSwap();
    }
  }
  
  // Button bindings
  const btnA = document.getElementById('btnA');
  const btnB = document.getElementById('btnB');
  
  let bHoldTimer = null;
  
  btnA.addEventListener('click', handleA);
  btnA.addEventListener('touchstart', e => e.preventDefault());
  btnA.addEventListener('touchend', e => { e.preventDefault(); handleA(); });
  
  btnB.addEventListener('mousedown', () => {
    bHoldTimer = setTimeout(handleBHold, 400); // Hold for 400ms to swap
  });
  btnB.addEventListener('mouseup', () => {
    if (bHoldTimer) { clearTimeout(bHoldTimer); bHoldTimer = null; }
    if (!swapMode) handleB(); // Only rotate if we didn't enter swap mode
  });
  btnB.addEventListener('touchstart', e => {
    e.preventDefault();
    bHoldTimer = setTimeout(handleBHold, 400);
  });
  btnB.addEventListener('touchend', e => {
    e.preventDefault();
    if (bHoldTimer) { clearTimeout(bHoldTimer); bHoldTimer = null; }
    if (!swapMode) handleB();
  });
  
  document.getElementById('btnUp').onclick = () => moveCursor(0, -1);
  document.getElementById('btnDown').onclick = () => moveCursor(0, 1);
  document.getElementById('btnLeft').onclick = () => moveCursor(-1, 0);
  document.getElementById('btnRight').onclick = () => moveCursor(1, 0);
  
  ['btnUp','btnDown','btnLeft','btnRight'].forEach(id => {
    document.getElementById(id).addEventListener('touchstart', e => { e.preventDefault(); document.getElementById(id).click(); });
  });
  
  // Keyboard
  let xHoldTimer = null;
  
  document.addEventListener('keydown', e => {
    if (overlay.style.display === 'none') return;
    if (e.repeat) return; // Ignore key repeat
    
    switch(e.key) {
      case 'ArrowUp': case 'w': moveCursor(0, -1); break;
      case 'ArrowDown': case 's': moveCursor(0, 1); break;
      case 'ArrowLeft': case 'a': moveCursor(-1, 0); break;
      case 'ArrowRight': case 'd': moveCursor(1, 0); break;
      case ' ': case 'z': e.preventDefault(); handleA(); break;
      case 'x': 
        e.preventDefault();
        xHoldTimer = setTimeout(handleBHold, 400);
        break;
      case 'Escape': hideGame(); break;
    }
  });
  
  document.addEventListener('keyup', e => {
    if (e.key === 'x') {
      if (xHoldTimer) { clearTimeout(xHoldTimer); xHoldTimer = null; }
      if (!swapMode) handleB();
    }
  });
})();
</script>

<!-- ═══════════════════════════════════════════════════════════════════════════
     FLOWSTATE - WASTEWATER TREATMENT PLANT RPG v4
     Functional equipment, chaos effects, 4 areas
═══════════════════════════════════════════════════════════════════════════ -->

<style>
  #flowstateOverlay * { box-sizing: border-box; }
  @keyframes pulseGlow { 0%, 100% { box-shadow: 0 0 20px rgba(255,200,0,0.3); } 50% { box-shadow: 0 0 30px rgba(255,200,0,0.6); } }
  .fs-mobile-controls { display: none; }
  @media (max-width: 768px), (pointer: coarse) { .fs-mobile-controls { display: flex !important; } }
</style>

<div id="flowstateOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(180deg, #7EC8E3 0%, #B5E3F5 50%, #E8F6FC 100%); z-index: 1000; overflow: hidden;">

  <div style="position: absolute; top: 5%; left: 10%; width: 120px; height: 40px; background: rgba(255,255,255,0.8); border-radius: 50px; filter: blur(2px);"></div>
  <div style="position: absolute; top: 8%; right: 15%; width: 80px; height: 30px; background: rgba(255,255,255,0.7); border-radius: 40px; filter: blur(2px);"></div>

<button id="closeFlowstateBtn" style="position: absolute; top: 12px; right: 12px; width: 40px; height: 40px; background: rgba(255,255,255,0.9); border: 2px solid #2d5a27; border-radius: 50%; color: #2d5a27; font-size: 20px; cursor: pointer; z-index: 1002;">×</button>

  <div id="flowstateContainer" style="max-width: 820px; margin: 0 auto; padding: 15px; height: 100%; display: flex; flex-direction: column; justify-content: center;">

```
<div style="text-align: center; margin-bottom: 10px;">
  <div style="font-family: Georgia, serif; font-size: 26px; font-weight: bold; color: #2d5a27; text-shadow: 2px 2px 0 rgba(255,255,255,0.8);">✦ FLOWSTATE ✦</div>
  <div style="font-family: Georgia, serif; font-size: 11px; color: #5a8a54; font-style: italic;">A Day at the Plant · Grady Watts, Operator</div>
</div>

<div style="position: relative; background: linear-gradient(135deg, #8B7355 0%, #6B5344 100%); border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.25); padding: 10px; border: 4px solid #5D4E37;">
  
  <canvas id="flowstateCanvas" width="780" height="440" style="display: block; width: 100%; border-radius: 10px;"></canvas>
  
  <div id="fsHUD" style="position: absolute; top: 18px; left: 18px; right: 18px; display: none; justify-content: space-between; align-items: flex-start; pointer-events: none;">
    <div style="background: linear-gradient(135deg, #FFFBEA, #FFF3C4); padding: 6px 14px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); border: 2px solid #E6C864;">
      <span style="font-family: Georgia, serif; font-size: 13px; color: #8B6914; font-weight: bold;">🪙 <span id="fsCoinCount">0</span></span>
    </div>
    <div id="fsZoneName" style="background: linear-gradient(135deg, #2d5a27, #1e4a1e); padding: 6px 16px; border-radius: 16px; color: #C4E6B8; font-family: Georgia, serif; font-size: 12px; font-weight: bold;"></div>
  </div>
  
  <div id="fsDialogBox" style="position: absolute; bottom: 18px; left: 18px; right: 18px; display: none; z-index: 100;">
    <div style="background: linear-gradient(180deg, #FFFFF8, #F5F0E0); border: 3px solid #8B7355; border-radius: 12px; padding: 12px 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.25);">
      <div style="display: flex; align-items: flex-start; gap: 12px;">
        <div id="fsDialogPortrait" style="width: 44px; height: 44px; background: linear-gradient(135deg, #FF6F00, #E65100); border-radius: 50%; border: 2px solid #8B7355; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
          <span style="font-size: 20px;">👷</span>
        </div>
        <div style="flex: 1;">
          <div id="fsDialogSpeaker" style="font-family: Georgia, serif; font-size: 11px; color: #8B6914; font-weight: bold; margin-bottom: 4px;">GRADY</div>
          <div id="fsDialogText" style="font-family: Georgia, serif; font-size: 13px; color: #3a3a3a; line-height: 1.5;"></div>
        </div>
      </div>
      <div style="text-align: right; margin-top: 8px;">
        <span style="font-family: Georgia, serif; font-size: 10px; color: #8B7355;">Press A ▸</span>
      </div>
    </div>
  </div>
  
  <div id="fsShopModal" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 110;">
    <div style="background: linear-gradient(180deg, #FFFFF8, #E8E0D0); border: 4px solid #5D4E37; border-radius: 16px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); min-width: 300px;">
      <div style="text-align: center; margin-bottom: 16px;">
        <div style="font-family: Georgia, serif; font-size: 18px; color: #2d5a27; font-weight: bold;">🔧 TOOL CRIB 🔧</div>
        <div style="font-family: Georgia, serif; font-size: 11px; color: #8B7355;">Coins: <span id="fsShopCoins" style="color: #8B6914; font-weight: bold;">0</span></div>
      </div>
      <div id="fsShopItems" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;"></div>
      <div style="text-align: center; font-family: Georgia, serif; font-size: 10px; color: #8B7355;">↑↓ Select · A Buy · B Close</div>
    </div>
  </div>
  
  <div id="fsStartScreen" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(180deg, rgba(126,200,227,0.97), rgba(200,230,200,0.97)); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 120;">
    <div style="position: absolute; top: 30px; right: 60px; width: 60px; height: 60px; background: radial-gradient(circle, #FFE066 0%, #FFB800 60%, transparent 70%); border-radius: 50%;"></div>
    <div style="font-family: Georgia, serif; font-size: 36px; font-weight: bold; color: #2d5a27; text-shadow: 3px 3px 0 rgba(255,255,255,0.8);">FLOWSTATE</div>
    <div style="font-family: Georgia, serif; font-size: 13px; color: #5a8a54; font-style: italic; margin-bottom: 20px;">The Anti-Thought-Leadership Game</div>
    
    <div style="width: 70px; height: 90px; margin-bottom: 16px;">
      <svg width="70" height="90" viewBox="0 0 70 90">
        <ellipse cx="35" cy="85" rx="18" ry="5" fill="rgba(0,0,0,0.2)"/>
        <rect x="22" y="70" width="10" height="14" rx="2" fill="#5D4037"/>
        <rect x="38" y="70" width="10" height="14" rx="2" fill="#5D4037"/>
        <rect x="20" y="50" width="12" height="24" rx="2" fill="#4A6FA5"/>
        <rect x="38" y="50" width="12" height="24" rx="2" fill="#4A6FA5"/>
        <rect x="18" y="48" width="34" height="5" fill="#5D4037"/>
        <rect x="16" y="26" width="38" height="24" rx="3" fill="#FF6F00"/>
        <rect x="18" y="32" width="34" height="3" fill="#FFECB3"/>
        <rect x="18" y="40" width="34" height="3" fill="#FFECB3"/>
        <rect x="8" y="28" width="10" height="18" rx="3" fill="#FF6F00"/>
        <rect x="52" y="28" width="10" height="18" rx="3" fill="#FF6F00"/>
        <circle cx="13" cy="48" r="4" fill="#FFCCBC"/>
        <circle cx="57" cy="48" r="4" fill="#FFCCBC"/>
        <rect x="28" y="20" width="14" height="8" fill="#FFCCBC"/>
        <ellipse cx="35" cy="14" rx="12" ry="11" fill="#FFCCBC"/>
        <ellipse cx="35" cy="6" rx="14" ry="5" fill="#FFD700"/>
        <rect x="22" y="3" width="26" height="6" rx="2" fill="#FFD700"/>
        <circle cx="30" cy="12" r="2" fill="#4A4A4A"/>
        <circle cx="40" cy="12" r="2" fill="#4A4A4A"/>
        <path d="M32 17 Q35 19 38 17" stroke="#8B6914" stroke-width="1.5" fill="none"/>
      </svg>
    </div>
    
    <div style="font-family: Georgia, serif; font-size: 12px; color: #3a5a3a; text-align: center; line-height: 1.6; max-width: 320px; margin-bottom: 16px;">
      You're <strong>Grady Watts</strong>, veteran operator.<br>
      Flip switches. Control equipment. Cause chaos.<br>
      Read signs. Buy hats. Survive the shift.
    </div>
    
    <div style="display: flex; gap: 16px; margin-bottom: 20px;">
      <div style="text-align: center; padding: 8px 14px; background: rgba(255,255,255,0.8); border: 2px solid #4a8a44; border-radius: 8px;">
        <div style="font-family: Georgia, serif; font-size: 13px; color: #2d5a27; font-weight: bold;">WASD</div>
        <div style="font-family: Georgia, serif; font-size: 9px; color: #5a8a54;">Move</div>
      </div>
      <div style="text-align: center; padding: 8px 14px; background: rgba(255,255,255,0.8); border: 2px solid #4a8a44; border-radius: 8px;">
        <div style="font-family: Georgia, serif; font-size: 13px; color: #2d5a27; font-weight: bold;">SPACE</div>
        <div style="font-family: Georgia, serif; font-size: 9px; color: #5a8a54;">Interact</div>
      </div>
    </div>
    
    <button id="fsStartBtn" style="padding: 12px 36px; background: linear-gradient(180deg, #4CAF50, #388E3C); border: 3px solid #2E7D32; border-radius: 20px; color: #fff; font-family: Georgia, serif; font-size: 15px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #1B5E20;">
      ▶ START SHIFT
    </button>
  </div>
  
</div>

<div class="fs-mobile-controls" style="margin-top: 12px; justify-content: space-between; align-items: center; padding: 0 10px;">
  <div style="position: relative; width: 110px; height: 110px;">
    <button id="fsBtnUp" style="position: absolute; left: 50%; top: 0; transform: translateX(-50%); width: 38px; height: 38px; background: linear-gradient(180deg, #fff, #e0e0e0); border: 3px solid #4CAF50; border-radius: 50%; color: #2d5a27; font-size: 14px; font-weight: bold; cursor: pointer;">▲</button>
    <button id="fsBtnDown" style="position: absolute; left: 50%; bottom: 0; transform: translateX(-50%); width: 38px; height: 38px; background: linear-gradient(180deg, #fff, #e0e0e0); border: 3px solid #4CAF50; border-radius: 50%; color: #2d5a27; font-size: 14px; font-weight: bold; cursor: pointer;">▼</button>
    <button id="fsBtnLeft" style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 38px; height: 38px; background: linear-gradient(180deg, #fff, #e0e0e0); border: 3px solid #4CAF50; border-radius: 50%; color: #2d5a27; font-size: 14px; font-weight: bold; cursor: pointer;">◀</button>
    <button id="fsBtnRight" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); width: 38px; height: 38px; background: linear-gradient(180deg, #fff, #e0e0e0); border: 3px solid #4CAF50; border-radius: 50%; color: #2d5a27; font-size: 14px; font-weight: bold; cursor: pointer;">▶</button>
  </div>
  <div style="display: flex; gap: 14px;">
    <button id="fsBtnB" style="width: 52px; height: 52px; background: linear-gradient(180deg, #FF9800, #F57C00); border: 3px solid #E65100; border-radius: 50%; color: #fff; font-family: Georgia, serif; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #BF360C;">B</button>
    <button id="fsBtnA" style="width: 52px; height: 52px; background: linear-gradient(180deg, #4CAF50, #388E3C); border: 3px solid #2E7D32; border-radius: 50%; color: #fff; font-family: Georgia, serif; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #1B5E20;">A</button>
  </div>
</div>
```

  </div>
</div>

<script>
(function() {
  const canvas = document.getElementById('flowstateCanvas');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  
  const overlay = document.getElementById('flowstateOverlay');
  const startScreen = document.getElementById('fsStartScreen');
  const dialogBox = document.getElementById('fsDialogBox');
  const dialogText = document.getElementById('fsDialogText');
  const dialogSpeaker = document.getElementById('fsDialogSpeaker');
  const shopModal = document.getElementById('fsShopModal');
  const hud = document.getElementById('fsHUD');
  const zoneName = document.getElementById('fsZoneName');
  const coinDisplay = document.getElementById('fsCoinCount');
  
  let state = 'menu';
  let coins = 0;
  let currentHat = 'hardhat';
  const ownedItems = ['hardhat'];
  let currentZone = 'control';
  let dialogQueue = [];
  let shopSelection = 0;
  let gameTime = 0;
  
  // Equipment state (shared across zones)
  const equipment = {
    clarifier1: { running: true, speed: 1 },
    clarifier2: { running: true, speed: 1 },
    clarifier3: { running: false, speed: 0 },
    pump1: { running: true, flow: 1 },
    pump2: { running: false, flow: 0 },
    pump3: { running: true, flow: 1 },
    mainValve: { open: true },
    bypassValve: { open: false }
  };
  
  // Chaos particles (water sprays, sparks, etc)
  let chaosParticles = [];
  
  const player = {
    x: 380, y: 300,
    w: 28, h: 40,
    speed: 3,
    dir: 'down',
    walking: false,
    frame: 0
  };
  
  const keys = { up: false, down: false, left: false, right: false };
  
  // 4 Zones with functional switches
  const zones = {
    control: {
      name: 'Control Room',
      bgColor: '#4A5568',
      floorColor: '#718096',
      indoor: true,
      objects: [
        // Control panels
        { type: 'control_panel', x: 200, y: 80, w: 380, h: 60 },
        // Switches that control equipment
        { type: 'switch', x: 240, y: 160, w: 50, h: 60, controls: 'clarifier1', label: 'CLAR 1' },
        { type: 'switch', x: 320, y: 160, w: 50, h: 60, controls: 'clarifier2', label: 'CLAR 2' },
        { type: 'switch', x: 400, y: 160, w: 50, h: 60, controls: 'clarifier3', label: 'CLAR 3' },
        { type: 'switch', x: 500, y: 160, w: 50, h: 60, controls: 'mainValve', label: 'MAIN' },
        // Signs
        { type: 'sign', x: 100, y: 120, text: '"If it ain\'t alarming,\ndon\'t touch it."\n— Plant Wisdom' },
        { type: 'sign', x: 620, y: 120, text: 'NOTICE:\nSCADA lies.\nTrust your gut.' },
        // Coins
        { type: 'coin', x: 150, y: 350, collected: false },
        // Zone exits
        { type: 'door', x: 360, y: 380, w: 60, h: 40, to: 'clarifiers', label: 'TO CLARIFIERS' },
        { type: 'door', x: 680, y: 200, w: 40, h: 60, to: 'pumps', label: 'PUMPS →' },
        { type: 'door', x: 60, y: 200, w: 40, h: 60, to: 'toolcrib', label: '← TOOLS' },
        // NPC
        { type: 'npc', x: 600, y: 320, name: 'Chase', role: 'greenhorn' }
      ]
    },
    clarifiers: {
      name: 'Clarifier Gallery',
      bgColor: '#7CB342',
      floorColor: '#B0B0A8',
      indoor: false,
      objects: [
        // Three clarifier tanks
        { type: 'clarifier', x: 150, y: 180, r: 80, equipId: 'clarifier1' },
        { type: 'clarifier', x: 400, y: 180, r: 80, equipId: 'clarifier2' },
        { type: 'clarifier', x: 650, y: 180, r: 70, equipId: 'clarifier3' },
        // Local override switches
        { type: 'switch', x: 150, y: 300, w: 40, h: 50, controls: 'clarifier1', label: 'C1', local: true },
        { type: 'switch', x: 400, y: 300, w: 40, h: 50, controls: 'clarifier2', label: 'C2', local: true },
        { type: 'switch', x: 650, y: 300, w: 40, h: 50, controls: 'clarifier3', label: 'C3', local: true },
        // Signs
        { type: 'sign', x: 50, y: 80, text: 'CLARIFIER GALLERY\n"Where solids go\nto contemplate."' },
        { type: 'sign', x: 280, y: 380, text: 'Sludge blanket\nchecks: Tuesdays\n(or when bored)' },
        // Coins
        { type: 'coin', x: 550, y: 380, collected: false },
        { type: 'coin', x: 720, y: 100, collected: false },
        // Door back
        { type: 'door', x: 360, y: 400, w: 60, h: 30, to: 'control', label: 'CONTROL ROOM' }
      ]
    },
    pumps: {
      name: 'Pump Station',
      bgColor: '#78909C',
      floorColor: '#90A4AE',
      indoor: true,
      objects: [
        // Three pumps
        { type: 'pump', x: 120, y: 100, w: 100, h: 120, equipId: 'pump1' },
        { type: 'pump', x: 340, y: 100, w: 100, h: 120, equipId: 'pump2' },
        { type: 'pump', x: 560, y: 100, w: 100, h: 120, equipId: 'pump3' },
        // Switches
        { type: 'switch', x: 145, y: 250, w: 50, h: 60, controls: 'pump1', label: 'P1' },
        { type: 'switch', x: 365, y: 250, w: 50, h: 60, controls: 'pump2', label: 'P2' },
        { type: 'switch', x: 585, y: 250, w: 50, h: 60, controls: 'pump3', label: 'P3' },
        // Bypass valve
        { type: 'switch', x: 700, y: 150, w: 50, h: 60, controls: 'bypassValve', label: 'BYPASS' },
        // Signs
        { type: 'sign', x: 50, y: 340, text: 'PUMP STATION\nLoud noises normal.\nSilence is bad.' },
        { type: 'sign', x: 680, y: 340, text: 'BYPASS VALVE:\nFor emergencies\nor Mondays.' },
        // Coins
        { type: 'coin', x: 280, y: 350, collected: false },
        // NPC
        { type: 'npc', x: 500, y: 350, name: 'Sly', role: 'veteran' },
        // Door
        { type: 'door', x: 60, y: 200, w: 40, h: 60, to: 'control', label: '← CONTROL' }
      ]
    },
    toolcrib: {
      name: 'Tool Crib',
      bgColor: '#8D6E63',
      floorColor: '#A1887F',
      indoor: true,
      objects: [
        // Shelving
        { type: 'shelving', x: 100, y: 80, w: 580, h: 100 },
        // Shop counter
        { type: 'shop', x: 320, y: 220, w: 140, h: 50 },
        // Signs
        { type: 'sign', x: 100, y: 200, text: 'TOOL CRIB\n"Borrow" responsibly.\nWe know who you are.' },
        { type: 'sign', x: 550, y: 200, text: 'Lost tools?\nCheck the\nclarifier.' },
        { type: 'sign', x: 320, y: 340, text: 'HATS: Because\nOSHA cares\nabout your head.' },
        // Coins
        { type: 'coin', x: 680, y: 350, collected: false },
        // EXIT - prominent
        { type: 'exit_door', x: 680, y: 180, w: 60, h: 80, to: 'control', label: 'EXIT →' },
        { type: 'door', x: 60, y: 180, w: 40, h: 60, to: 'control', label: '← EXIT' }
      ]
    }
  };
  
  // Shop items
  const shopItems = [
    { id: 'hardhat', name: 'Hard Hat', price: 0, desc: 'OSHA standard issue' },
    { id: 'trucker', name: 'Trucker Cap', price: 5, desc: '"Flush Happens"' },
    { id: 'cowboy', name: 'Cowboy Hat', price: 10, desc: 'Lone operator vibes' },
    { id: 'chef', name: 'Chef Hat', price: 15, desc: 'Cookin\' up sludge' }
  ];
  
  // Dialogue
  const dialogue = {
    switch_on: [
      "Flipped it on. Let's see what breaks.",
      "Started her up. The hum sounds healthy. For now.",
      "Online. If SCADA complains, that's tomorrow's problem.",
      "Running. I'll log it as 'preventive maintenance.'"
    ],
    switch_off: [
      "Shut it down. Sometimes rest is the answer.",
      "Offline. The silence is almost peaceful.",
      "Stopped. Hope nobody needed that.",
      "Off. That'll get some attention at shift change."
    ],
    valve_open: [
      "Valve open. Flow restored.",
      "Opened her up. Water finds a way.",
      "Flow initiated. Check downstream."
    ],
    valve_close: [
      "Valve closed. Flow stopped.",
      "Shut the valve. Pressure's building somewhere.",
      "Closed. Someone downstream will notice."
    ],
    clarifier: [
      "Settling nice. The rake arm's doing its job.",
      "Circular motion. Day after day. Like this career.",
      "Sludge blanket's good. I'll write that down somewhere."
    ],
    pump: [
      "Positive displacement. Unlike my career trajectory.",
      "Listen to that hum. Steady. Reliable.",
      "These pumps have seen three managers come and go."
    ],
    pump_off: [
      "Offline. Someone's got a work order. Probably.",
      "Not running. The silence is concerning, actually."
    ],
    chaos: [
      "Well. That's gonna need a work order.",
      "Didn't expect that. But I'm not surprised.",
      "That's... not ideal. But it's also not my problem.",
      "The day shift is going to love this."
    ],
    sign_read: [], // filled dynamically
    coin: [
      "Operator coin. Every shift survived is a victory.",
      "Found one. The plant provides."
    ],
    shop: [
      "Tool Crib. Where dreams meet budget constraints."
    ]
  };
  
  const npcDialogue = {
    Chase: [
      { speaker: 'Chase', text: "Grady! I read this LinkedIn post about optimizing our biosolids with machine learning..." },
      { speaker: 'Grady', text: "Chase. See that pump? It's making a noise." },
      { speaker: 'Chase', text: "But the algorithm could predict—" },
      { speaker: 'Grady', text: "The algorithm can wait. That noise means something. Listen." }
    ],
    Sly: [
      { speaker: 'Sly', text: "..." },
      { speaker: 'Grady', text: "How's Pump 2?" },
      { speaker: 'Sly', text: "Thinking." },
      { speaker: 'Grady', text: "Pumps don't think, Sly." },
      { speaker: 'Sly', text: "This one does. Started yesterday." },
      { speaker: 'Grady', text: "...I'll add it to the log." }
    ]
  };
  
  let currentNpcDialogue = [];
  let npcDialogueIndex = 0;
  
  function getLine(category) {
    const lines = dialogue[category] || ["..."];
    return lines[Math.floor(Math.random() * lines.length)];
  }
  
  function showGame() {
    overlay.style.display = 'block';
    requestAnimationFrame(gameLoop);
  }
  
  function hideGame() {
    overlay.style.display = 'none';
  }
  
  document.getElementById('launchFlowstateBtn').onclick = showGame;
  document.getElementById('closeFlowstateBtn').onclick = hideGame;
  document.getElementById('fsStartBtn').onclick = startGame;
  
  function startGame() {
    state = 'playing';
    startScreen.style.display = 'none';
    hud.style.display = 'flex';
    player.x = 380;
    player.y = 320;
    currentZone = 'control';
    updateZoneName();
  }
  
  function updateZoneName() {
    zoneName.textContent = zones[currentZone].name;
  }
  
  function showDialog(text, speaker = 'Grady') {
    dialogQueue.push({ text, speaker });
    if (state !== 'dialog' && state !== 'npc_dialog') {
      state = 'dialog';
      displayDialogLine(dialogQueue[0]);
      dialogBox.style.display = 'block';
    }
  }
  
  function displayDialogLine(line) {
    dialogSpeaker.textContent = line.speaker.toUpperCase();
    dialogText.textContent = line.text;
    
    const portrait = document.getElementById('fsDialogPortrait');
    if (line.speaker === 'Grady') {
      portrait.style.background = 'linear-gradient(135deg, #FF6F00, #E65100)';
    } else if (line.speaker === 'Chase') {
      portrait.style.background = 'linear-gradient(135deg, #FF8A65, #FF5722)';
    } else {
      portrait.style.background = 'linear-gradient(135deg, #607D8B, #455A64)';
    }
  }
  
  function advanceDialog() {
    dialogQueue.shift();
    if (dialogQueue.length > 0) {
      displayDialogLine(dialogQueue[0]);
    } else {
      dialogBox.style.display = 'none';
      state = 'playing';
    }
  }
  
  function startNpcDialogue(name) {
    if (npcDialogue[name]) {
      currentNpcDialogue = npcDialogue[name];
      npcDialogueIndex = 0;
      state = 'npc_dialog';
      displayDialogLine(currentNpcDialogue[0]);
      dialogBox.style.display = 'block';
    }
  }
  
  function advanceNpcDialogue() {
    npcDialogueIndex++;
    if (npcDialogueIndex < currentNpcDialogue.length) {
      displayDialogLine(currentNpcDialogue[npcDialogueIndex]);
    } else {
      dialogBox.style.display = 'none';
      state = 'playing';
      currentNpcDialogue = [];
      npcDialogueIndex = 0;
    }
  }
  
  function openShop() {
    state = 'shop';
    shopSelection = 0;
    document.getElementById('fsShopCoins').textContent = coins;
    renderShop();
    shopModal.style.display = 'block';
  }
  
  function closeShop() {
    shopModal.style.display = 'none';
    state = 'playing';
  }
  
  function renderShop() {
    const container = document.getElementById('fsShopItems');
    container.innerHTML = '';
    shopItems.forEach((item, i) => {
      const owned = ownedItems.includes(item.id);
      const equipped = currentHat === item.id;
      const div = document.createElement('div');
      div.style.cssText = `padding: 8px 12px; background: ${i === shopSelection ? '#E8F5E9' : '#fff'}; border: 2px solid ${i === shopSelection ? '#4CAF50' : '#ddd'}; border-radius: 8px; display: flex; justify-content: space-between;`;
      div.innerHTML = `<div><div style="font-family: Georgia; font-size: 12px; color: #2d5a27; font-weight: bold;">${item.name}</div><div style="font-family: Georgia; font-size: 9px; color: #666;">${item.desc}</div></div><div style="font-family: Georgia; font-size: 11px; color: ${equipped ? '#4CAF50' : (owned ? '#8BC34A' : '#8B6914')};">${equipped ? '✓ EQUIPPED' : (owned ? 'OWNED' : '🪙 ' + item.price)}</div>`;
      container.appendChild(div);
    });
  }
  
  function shopAction() {
    const item = shopItems[shopSelection];
    if (ownedItems.includes(item.id)) {
      currentHat = item.id;
      renderShop();
    } else if (coins >= item.price) {
      coins -= item.price;
      ownedItems.push(item.id);
      currentHat = item.id;
      document.getElementById('fsShopCoins').textContent = coins;
      coinDisplay.textContent = coins;
      renderShop();
    }
  }
  
  // Spawn chaos particles
  function spawnChaos(x, y, type) {
    const count = type === 'water' ? 20 : 10;
    for (let i = 0; i < count; i++) {
      chaosParticles.push({
        x: x,
        y: y,
        vx: (Math.random() - 0.5) * (type === 'water' ? 8 : 4),
        vy: -Math.random() * (type === 'water' ? 10 : 5) - 2,
        life: 60 + Math.random() * 40,
        type: type,
        size: type === 'water' ? 3 + Math.random() * 3 : 2 + Math.random() * 2
      });
    }
  }
  
  function interact() {
    const zone = zones[currentZone];
    const px = player.x + player.w / 2;
    const py = player.y + player.h / 2;
    
    for (const obj of zone.objects) {
      const ox = obj.x + (obj.w || obj.r || 0) / 2;
      const oy = obj.y + (obj.h || obj.r || 0) / 2;
      const dist = Math.hypot(px - ox, py - oy);
      
      // Switch interaction
      if (obj.type === 'switch' && dist < 50) {
        const eq = equipment[obj.controls];
        if (eq.hasOwnProperty('running')) {
          eq.running = !eq.running;
          coins += 1;
          coinDisplay.textContent = coins;
          showDialog(getLine(eq.running ? 'switch_on' : 'switch_off'));
          // Chaos effect when toggling
          if (Math.random() < 0.3) {
            spawnChaos(obj.x + 25, obj.y, 'sparks');
            setTimeout(() => showDialog(getLine('chaos')), 1500);
          }
        } else if (eq.hasOwnProperty('open')) {
          eq.open = !eq.open;
          coins += 1;
          coinDisplay.textContent = coins;
          showDialog(getLine(eq.open ? 'valve_open' : 'valve_close'));
          // Water spray chaos
          if (eq.open && Math.random() < 0.4) {
            spawnChaos(obj.x + 25, obj.y - 20, 'water');
          }
        }
        return;
      }
      
      // Clarifier
      if (obj.type === 'clarifier' && dist < obj.r + 20) {
        showDialog(getLine('clarifier'));
        return;
      }
      
      // Pump
      if (obj.type === 'pump' && dist < 70) {
        const eq = equipment[obj.equipId];
        showDialog(getLine(eq.running ? 'pump' : 'pump_off'));
        return;
      }
      
      // Sign - read it
      if (obj.type === 'sign' && dist < 50) {
        showDialog(obj.text.replace(/\n/g, ' '));
        return;
      }
      
      // Shop
      if (obj.type === 'shop' && dist < 60) {
        showDialog(getLine('shop'));
        setTimeout(openShop, 600);
        return;
      }
      
      // NPC
      if (obj.type === 'npc' && dist < 50) {
        startNpcDialogue(obj.name);
        return;
      }
      
      // Door / exit
      if ((obj.type === 'door' || obj.type === 'exit_door') && dist < 50) {
        currentZone = obj.to;
        player.x = 380;
        player.y = obj.to === 'clarifiers' ? 380 : (obj.to === 'control' ? 320 : 320);
        updateZoneName();
        return;
      }
    }
  }
  
  function update(dt) {
    if (state !== 'playing') return;
    
    gameTime += dt;
    
    // Movement
    let dx = 0, dy = 0;
    if (keys.up) { dy = -player.speed; player.dir = 'up'; }
    if (keys.down) { dy = player.speed; player.dir = 'down'; }
    if (keys.left) { dx = -player.speed; player.dir = 'left'; }
    if (keys.right) { dx = player.speed; player.dir = 'right'; }
    
    player.walking = dx !== 0 || dy !== 0;
    if (player.walking) player.frame += 0.15;
    
    player.x = Math.max(20, Math.min(W - player.w - 20, player.x + dx));
    player.y = Math.max(70, Math.min(H - player.h - 20, player.y + dy));
    
    // Coin collection
    const zone = zones[currentZone];
    for (const obj of zone.objects) {
      if (obj.type === 'coin' && !obj.collected) {
        const dist = Math.hypot(player.x + player.w/2 - obj.x, player.y + player.h/2 - obj.y);
        if (dist < 25) {
          obj.collected = true;
          coins++;
          coinDisplay.textContent = coins;
          showDialog(getLine('coin'));
        }
      }
    }
    
    // Update chaos particles
    chaosParticles = chaosParticles.filter(p => {
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.3; // gravity
      p.life--;
      return p.life > 0;
    });
    
    // Animate running equipment
    for (const obj of zone.objects) {
      if (obj.type === 'clarifier') {
        const eq = equipment[obj.equipId];
        if (eq.running) {
          obj.armAngle = (obj.armAngle || 0) + dt * 0.4;
        }
      }
    }
  }
  
  function draw() {
    const zone = zones[currentZone];
    
    // Background
    if (zone.indoor) {
      ctx.fillStyle = zone.bgColor;
      ctx.fillRect(0, 0, W, H);
      ctx.fillStyle = zone.floorColor;
      ctx.fillRect(0, 60, W, H - 60);
      // Floor tiles
      ctx.strokeStyle = 'rgba(0,0,0,0.1)';
      for (let x = 0; x < W; x += 40) {
        ctx.beginPath(); ctx.moveTo(x, 60); ctx.lineTo(x, H); ctx.stroke();
      }
      for (let y = 60; y < H; y += 40) {
        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
      }
    } else {
      // Outdoor sky
      const sky = ctx.createLinearGradient(0, 0, 0, H);
      sky.addColorStop(0, '#87CEEB');
      sky.addColorStop(0.4, '#B5E3F5');
      ctx.fillStyle = sky;
      ctx.fillRect(0, 0, W, H);
      // Grass
      ctx.fillStyle = zone.bgColor;
      ctx.fillRect(0, 60, W, H - 60);
      // Concrete path
      ctx.fillStyle = zone.floorColor;
      ctx.fillRect(100, 350, 580, 90);
      ctx.fillRect(340, 60, 100, 380);
    }
    
    // Sort and draw objects
    const sorted = [...zone.objects].sort((a, b) => (a.y + (a.h || a.r || 0)) - (b.y + (b.h || b.r || 0)));
    for (const obj of sorted) {
      drawObject(obj);
    }
    
    // Draw player
    drawPlayer();
    
    // Draw chaos particles
    for (const p of chaosParticles) {
      ctx.fillStyle = p.type === 'water' ? `rgba(100, 180, 255, ${p.life / 60})` : `rgba(255, 200, 50, ${p.life / 60})`;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx.fill();
    }
  }
  
  function drawObject(obj) {
    ctx.save();
    
    if (obj.type === 'control_panel') {
      ctx.fillStyle = '#2D3748';
      ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
      ctx.fillStyle = '#1A202C';
      ctx.fillRect(obj.x + 5, obj.y + 5, obj.w - 10, obj.h - 10);
      // Screens
      for (let i = 0; i < 6; i++) {
        ctx.fillStyle = '#1B5E20';
        ctx.fillRect(obj.x + 15 + i * 60, obj.y + 10, 50, 35);
        ctx.fillStyle = '#4CAF50';
        ctx.fillRect(obj.x + 20 + i * 60, obj.y + 15, 40, 8);
        ctx.fillRect(obj.x + 20 + i * 60, obj.y + 28, 40, 8);
      }
    }
    
    if (obj.type === 'switch') {
      const eq = equipment[obj.controls];
      const isOn = eq.running !== undefined ? eq.running : eq.open;
      
      // Panel
      ctx.fillStyle = '#455A64';
      ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
      ctx.fillStyle = '#37474F';
      ctx.fillRect(obj.x + 3, obj.y + 3, obj.w - 6, obj.h - 6);
      
      // Switch lever
      ctx.fillStyle = isOn ? '#4CAF50' : '#F44336';
      ctx.shadowColor = isOn ? '#4CAF50' : '#F44336';
      ctx.shadowBlur = 8;
      ctx.fillRect(obj.x + 15, obj.y + (isOn ? 10 : 30), 20, 20);
      ctx.shadowBlur = 0;
      
      // Label
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 9px Georgia';
      ctx.textAlign = 'center';
      ctx.fillText(obj.label, obj.x + obj.w/2, obj.y + obj.h + 12);
      ctx.fillText(isOn ? 'ON' : 'OFF', obj.x + obj.w/2, obj.y + obj.h + 22);
    }
    
    if (obj.type === 'clarifier') {
      const eq = equipment[obj.equipId];
      
      // Shadow
      ctx.fillStyle = 'rgba(0,0,0,0.2)';
      ctx.beginPath();
      ctx.ellipse(obj.x, obj.y + obj.r * 0.2, obj.r * 1.1, obj.r * 0.3, 0, 0, Math.PI * 2);
      ctx.fill();
      
      // Tank
      const tankGrad = ctx.createRadialGradient(obj.x - obj.r * 0.3, obj.y - obj.r * 0.3, 0, obj.x, obj.y, obj.r);
      tankGrad.addColorStop(0, '#E0E0E0');
      tankGrad.addColorStop(1, '#909090');
      ctx.fillStyle = tankGrad;
      ctx.beginPath();
      ctx.arc(obj.x, obj.y, obj.r, 0, Math.PI * 2);
      ctx.fill();
      
      // Water
      const waterGrad = ctx.createRadialGradient(obj.x, obj.y, 0, obj.x, obj.y, obj.r * 0.85);
      waterGrad.addColorStop(0, eq.running ? '#81D4FA' : '#90A4AE');
      waterGrad.addColorStop(1, eq.running ? '#29B6F6' : '#607D8B');
      ctx.fillStyle = waterGrad;
      ctx.beginPath();
      ctx.arc(obj.x, obj.y, obj.r * 0.85, 0, Math.PI * 2);
      ctx.fill();
      
      // Center hub
      ctx.fillStyle = '#505050';
      ctx.beginPath();
      ctx.arc(obj.x, obj.y, 10, 0, Math.PI * 2);
      ctx.fill();
      
      // Arm (only rotates if running)
      if (eq.running) {
        ctx.strokeStyle = '#404040';
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.moveTo(obj.x, obj.y);
        const angle = obj.armAngle || 0;
        ctx.lineTo(obj.x + Math.cos(angle) * obj.r * 0.8, obj.y + Math.sin(angle) * obj.r * 0.8);
        ctx.stroke();
      } else {
        // Static arm
        ctx.strokeStyle = '#606060';
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.moveTo(obj.x, obj.y);
        ctx.lineTo(obj.x + obj.r * 0.8, obj.y);
        ctx.stroke();
      }
      
      // Status indicator
      ctx.fillStyle = eq.running ? '#4CAF50' : '#F44336';
      ctx.beginPath();
      ctx.arc(obj.x, obj.y - obj.r - 10, 6, 0, Math.PI * 2);
      ctx.fill();
    }
    
    if (obj.type === 'pump') {
      const eq = equipment[obj.equipId];
      
      // Shadow
      ctx.fillStyle = 'rgba(0,0,0,0.2)';
      ctx.fillRect(obj.x + 5, obj.y + obj.h - 5, obj.w, 10);
      
      // Body
      const pumpGrad = ctx.createLinearGradient(obj.x, obj.y, obj.x + obj.w, obj.y);
      pumpGrad.addColorStop(0, eq.running ? '#43A047' : '#757575');
      pumpGrad.addColorStop(0.5, eq.running ? '#66BB6A' : '#9E9E9E');
      pumpGrad.addColorStop(1, eq.running ? '#43A047' : '#757575');
      ctx.fillStyle = pumpGrad;
      ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
      
      // Motor section
      ctx.fillStyle = '#37474F';
      ctx.fillRect(obj.x + 10, obj.y + obj.h - 35, obj.w - 20, 30);
      
      // Status light
      ctx.fillStyle = eq.running ? '#00E676' : '#FF5252';
      ctx.shadowColor = eq.running ? '#00E676' : '#FF5252';
      ctx.shadowBlur = eq.running ? 15 : 5;
      ctx.beginPath();
      ctx.arc(obj.x + obj.w/2, obj.y + 25, 10, 0, Math.PI * 2);
      ctx.fill();
      ctx.shadowBlur = 0;
      
      // Pipes
      ctx.fillStyle = '#546E7A';
      ctx.fillRect(obj.x - 15, obj.y + 40, 20, 20);
      ctx.fillRect(obj.x + obj.w - 5, obj.y + 60, 20, 20);
      
      // Vibration effect
      if (eq.running) {
        const vib = Math.sin(gameTime * 25) * 1.5;
        ctx.strokeStyle = 'rgba(255,255,255,0.3)';
        ctx.lineWidth = 2;
        ctx.strokeRect(obj.x + vib, obj.y, obj.w, obj.h);
        
        // Occasional water spray from running pump
        if (Math.random() < 0.01) {
          spawnChaos(obj.x + obj.w, obj.y + 60, 'water');
        }
      }
      
      // Label
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 12px Georgia';
      ctx.textAlign = 'center';
      ctx.fillText(obj.equipId.toUpperCase().replace('PUMP', 'PUMP '), obj.x + obj.w/2, obj.y + obj.h + 15);
    }
    
    if (obj.type === 'sign') {
      // Wooden post
      ctx.fillStyle = '#5D4037';
      ctx.fillRect(obj.x + 30, obj.y + 40, 8, 50);
      
      // Sign board
      ctx.fillStyle = '#8D6E63';
      ctx.fillRect(obj.x, obj.y, 70, 45);
      ctx.strokeStyle = '#5D4037';
      ctx.lineWidth = 2;
      ctx.strokeRect(obj.x, obj.y, 70, 45);
      
      // Text
      ctx.fillStyle = '#FFF8E1';
      ctx.font = '8px Georgia';
      ctx.textAlign = 'center';
      const lines = obj.text.split('\n');
      lines.forEach((line, i) => {
        ctx.fillText(line, obj.x + 35, obj.y + 12 + i * 10);
      });
    }
    
    if (obj.type === 'shelving') {
      ctx.fillStyle = '#6D4C41';
      ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
      // Shelves
      for (let i = 0; i < 3; i++) {
        ctx.fillStyle = '#8D6E63';
        ctx.fillRect(obj.x, obj.y + 25 + i * 30, obj.w, 5);
      }
      // Items on shelves
      ctx.fillStyle = '#FF9800';
      for (let i = 0; i < 8; i++) {
        ctx.fillRect(obj.x + 20 + i * 70, obj.y + 5, 20, 18);
      }
      ctx.fillStyle = '#2196F3';
      for (let i = 0; i < 7; i++) {
        ctx.fillRect(obj.x + 40 + i * 80, obj.y + 35, 25, 20);
      }
    }
    
    if (obj.type === 'shop') {
      ctx.fillStyle = '#5D4037';
      ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
      ctx.fillStyle = '#8D6E63';
      ctx.fillRect(obj.x + 5, obj.y + 5, obj.w - 10, obj.h - 10);
      ctx.fillStyle = '#FFF';
      ctx.font = 'bold 12px Georgia';
      ctx.textAlign = 'center';
      ctx.fillText('SHOP', obj.x + obj.w/2, obj.y + obj.h/2 + 4);
      ctx.font = '9px Georgia';
      ctx.fillText('Press A', obj.x + obj.w/2, obj.y + obj.h + 12);
    }
    
    if (obj.type === 'door' || obj.type === 'exit_door') {
      const isExit = obj.type === 'exit_door';
      // Door frame
      ctx.fillStyle = isExit ? '#2E7D32' : '#5D4037';
      ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
      ctx.fillStyle = isExit ? '#4CAF50' : '#795548';
      ctx.fillRect(obj.x + 3, obj.y + 3, obj.w - 6, obj.h - 6);
      
      // Handle
      ctx.fillStyle = '#FFD700';
      ctx.beginPath();
      ctx.arc(obj.x + obj.w - 12, obj.y + obj.h/2, 4, 0, Math.PI * 2);
      ctx.fill();
      
      // Label above
      ctx.fillStyle = isExit ? '#2E7D32' : '#5D4037';
      ctx.font = isExit ? 'bold 10px Georgia' : '9px Georgia';
      ctx.textAlign = 'center';
      ctx.fillText(obj.label, obj.x + obj.w/2, obj.y - 5);
    }
    
    if (obj.type === 'coin' && !obj.collected) {
      const bob = Math.sin(gameTime * 4 + obj.x) * 3;
      ctx.fillStyle = '#FFD700';
      ctx.shadowColor = '#FFD700';
      ctx.shadowBlur = 10;
      ctx.beginPath();
      ctx.arc(obj.x, obj.y + bob, 10, 0, Math.PI * 2);
      ctx.fill();
      ctx.shadowBlur = 0;
      ctx.fillStyle = '#FFC107';
      ctx.beginPath();
      ctx.arc(obj.x, obj.y + bob, 7, 0, Math.PI * 2);
      ctx.fill();
    }
    
    if (obj.type === 'npc') {
      const bob = Math.sin(gameTime * 2 + obj.x) * 1.5;
      const nx = obj.x, ny = obj.y;
      
      // Shadow
      ctx.fillStyle = 'rgba(0,0,0,0.2)';
      ctx.beginPath();
      ctx.ellipse(nx + 14, ny + 42, 12, 4, 0, 0, Math.PI * 2);
      ctx.fill();
      
      // Boots
      ctx.fillStyle = '#3E2723';
      ctx.fillRect(nx + 4, ny + 32 + bob, 8, 10);
      ctx.fillRect(nx + 16, ny + 32 + bob, 8, 10);
      
      // Pants
      ctx.fillStyle = obj.role === 'greenhorn' ? '#37474F' : '#455A64';
      ctx.fillRect(nx + 5, ny + 22 + bob, 7, 14);
      ctx.fillRect(nx + 16, ny + 22 + bob, 7, 14);
      
      // Vest/shirt
      ctx.fillStyle = obj.role === 'greenhorn' ? '#FF6F00' : '#546E7A';
      ctx.fillRect(nx + 2, ny + 8 + bob, 24, 16);
      if (obj.role === 'greenhorn') {
        ctx.fillStyle = '#FFECB3';
        ctx.fillRect(nx + 4, ny + 12 + bob, 20, 2);
        ctx.fillRect(nx + 4, ny + 18 + bob, 20, 2);
      }
      
      // Arms
      ctx.fillStyle = obj.role === 'greenhorn' ? '#FF6F00' : '#546E7A';
      ctx.fillRect(nx - 4, ny + 10 + bob, 8, 12);
      ctx.fillRect(nx + 24, ny + 10 + bob, 8, 12);
      
      // Hands
      ctx.fillStyle = '#FFCCBC';
      ctx.beginPath();
      ctx.arc(nx, ny + 24 + bob, 4, 0, Math.PI * 2);
      ctx.arc(nx + 28, ny + 24 + bob, 4, 0, Math.PI * 2);
      ctx.fill();
      
      // Head
      ctx.fillStyle = '#FFCCBC';
      ctx.beginPath();
      ctx.ellipse(nx + 14, ny + bob, 10, 9, 0, 0, Math.PI * 2);
      ctx.fill();
      
      // Hair/cap
      ctx.fillStyle = obj.role === 'greenhorn' ? '#5D4037' : '#37474F';
      ctx.beginPath();
      ctx.ellipse(nx + 14, ny - 5 + bob, 9, 5, 0, Math.PI, 0);
      ctx.fill();
      
      // Face
      ctx.fillStyle = '#4A4A4A';
      ctx.beginPath();
      ctx.arc(nx + 10, ny - 1 + bob, 1.5, 0, Math.PI * 2);
      ctx.arc(nx + 18, ny - 1 + bob, 1.5, 0, Math.PI * 2);
      ctx.fill();
      
      // Name
      ctx.fillStyle = 'rgba(0,0,0,0.7)';
      ctx.fillRect(nx - 2, ny - 20, 32, 12);
      ctx.fillStyle = '#fff';
      ctx.font = '8px Georgia';
      ctx.textAlign = 'center';
      ctx.fillText(obj.name, nx + 14, ny - 11);
      
      // Interaction hint
      const px = player.x + player.w/2;
      const py = player.y + player.h/2;
      if (Math.hypot(px - nx - 14, py - ny - 20) < 60 && state === 'playing') {
        ctx.fillStyle = '#4CAF50';
        ctx.fillRect(nx - 6, ny - 35, 40, 12);
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 8px Georgia';
        ctx.fillText('PRESS A', nx + 14, ny - 26);
      }
    }
    
    ctx.restore();
  }
  
  function drawPlayer() {
    const x = player.x;
    const y = player.y;
    const bob = player.walking ? Math.sin(player.frame * 0.5) * 2 : 0;
    const legOff = player.walking ? Math.sin(player.frame) * 4 : 0;
    
    ctx.save();
    
    // Shadow
    ctx.fillStyle = 'rgba(0,0,0,0.2)';
    ctx.beginPath();
    ctx.ellipse(x + player.w/2, y + player.h + 2, 14, 5, 0, 0, Math.PI * 2);
    ctx.fill();
    
    // Boots
    ctx.fillStyle = '#5D4037';
    ctx.fillRect(x + 4, y + 32 + bob - Math.abs(legOff)/2, 8, 10);
    ctx.fillRect(x + 16, y + 32 + bob + Math.abs(legOff)/2, 8, 10);
    
    // Jeans
    ctx.fillStyle = '#4A6FA5';
    ctx.fillRect(x + 5, y + 22 + bob, 7, 14);
    ctx.fillRect(x + 16, y + 22 + bob, 7, 14);
    
    // Belt
    ctx.fillStyle = '#5D4037';
    ctx.fillRect(x + 3, y + 20 + bob, 22, 4);
    ctx.fillStyle = '#C4A35A';
    ctx.fillRect(x + 11, y + 20 + bob, 6, 4);
    
    // Safety vest (bright orange)
    ctx.fillStyle = '#FF6F00';
    ctx.fillRect(x + 2, y + 8 + bob, 24, 14);
    // Reflective stripes
    ctx.fillStyle = '#FFECB3';
    ctx.fillRect(x + 4, y + 11 + bob, 20, 2);
    ctx.fillRect(x + 4, y + 17 + bob, 20, 2);
    
    // Arms
    ctx.fillStyle = '#FF6F00';
    ctx.fillRect(x - 4, y + 10 + bob, 8, 12);
    ctx.fillRect(x + 24, y + 10 + bob, 8, 12);
    
    // Hands
    ctx.fillStyle = '#E8C4A0';
    ctx.beginPath();
    ctx.arc(x, y + 24 + bob, 4, 0, Math.PI * 2);
    ctx.arc(x + 28, y + 24 + bob, 4, 0, Math.PI * 2);
    ctx.fill();
    
    // Neck
    ctx.fillStyle = '#E8C4A0';
    ctx.fillRect(x + 10, y + 4 + bob, 8, 6);
    
    // Head
    ctx.fillStyle = '#E8C4A0';
    ctx.beginPath();
    ctx.ellipse(x + 14, y + bob, 10, 9, 0, 0, Math.PI * 2);
    ctx.fill();
    
    // Hat
    if (currentHat === 'hardhat') {
      ctx.fillStyle = '#FFD700';
      ctx.beginPath();
      ctx.ellipse(x + 14, y - 6 + bob, 12, 5, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillRect(x + 4, y - 10 + bob, 20, 6);
    } else if (currentHat === 'trucker') {
      ctx.fillStyle = '#D32F2F';
      ctx.fillRect(x + 2, y - 6 + bob, 24, 8);
      ctx.beginPath();
      ctx.ellipse(x + 14, y - 6 + bob, 14, 4, 0, Math.PI, 0);
      ctx.fill();
    } else if (currentHat === 'cowboy') {
      ctx.fillStyle = '#8D6E63';
      ctx.beginPath();
      ctx.ellipse(x + 14, y - 4 + bob, 16, 5, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillRect(x + 6, y - 12 + bob, 16, 10);
    } else if (currentHat === 'chef') {
      ctx.fillStyle = '#fff';
      ctx.fillRect(x + 4, y - 10 + bob, 20, 14);
      ctx.beginPath();
      ctx.arc(x + 14, y - 8 + bob, 10, 0, Math.PI * 2);
      ctx.fill();
    }
    
    // Face
    ctx.fillStyle = '#4A4A4A';
    ctx.beginPath();
    ctx.arc(x + 10, y - 1 + bob, 1.5, 0, Math.PI * 2);
    ctx.arc(x + 18, y - 1 + bob, 1.5, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.strokeStyle = '#8B6914';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.arc(x + 14, y + 2 + bob, 4, 0.2, Math.PI - 0.2);
    ctx.stroke();
    
    ctx.restore();
  }
  
  let lastTime = 0;
  function gameLoop(time) {
    if (overlay.style.display === 'none') return;
    const dt = Math.min((time - lastTime) / 1000, 0.1);
    lastTime = time;
    update(dt);
    if (state !== 'menu') draw();
    requestAnimationFrame(gameLoop);
  }
  
  function handleA() {
    if (state === 'dialog') advanceDialog();
    else if (state === 'npc_dialog') advanceNpcDialogue();
    else if (state === 'shop') shopAction();
    else if (state === 'playing') interact();
  }
  
  function handleB() {
    if (state === 'shop') closeShop();
    else if (state === 'npc_dialog') {
      dialogBox.style.display = 'none';
      state = 'playing';
    }
  }
  
  // Keyboard
  document.addEventListener('keydown', e => {
    if (overlay.style.display === 'none') return;
    switch(e.key.toLowerCase()) {
      case 'w': case 'arrowup': keys.up = true; e.preventDefault(); break;
      case 's': case 'arrowdown': keys.down = true; e.preventDefault(); break;
      case 'a': case 'arrowleft': keys.left = true; e.preventDefault(); break;
      case 'd': case 'arrowright': keys.right = true; e.preventDefault(); break;
      case ' ': case 'z': case 'enter': e.preventDefault(); handleA(); break;
      case 'x': case 'escape': e.preventDefault(); handleB(); break;
    }
    if (state === 'shop') {
      if (e.key === 'ArrowUp' || e.key.toLowerCase() === 'w') { shopSelection = Math.max(0, shopSelection - 1); renderShop(); }
      if (e.key === 'ArrowDown' || e.key.toLowerCase() === 's') { shopSelection = Math.min(shopItems.length - 1, shopSelection + 1); renderShop(); }
    }
  });
  
  document.addEventListener('keyup', e => {
    switch(e.key.toLowerCase()) {
      case 'w': case 'arrowup': keys.up = false; break;
      case 's': case 'arrowdown': keys.down = false; break;
      case 'a': case 'arrowleft': keys.left = false; break;
      case 'd': case 'arrowright': keys.right = false; break;
    }
  });
  
  // Mobile
  const setupBtn = (id, dir) => {
    const btn = document.getElementById(id);
    if (!btn) return;
    btn.ontouchstart = e => { e.preventDefault(); keys[dir] = true; };
    btn.ontouchend = e => { e.preventDefault(); keys[dir] = false; };
    btn.onmousedown = () => keys[dir] = true;
    btn.onmouseup = () => keys[dir] = false;
    btn.onmouseleave = () => keys[dir] = false;
  };
  setupBtn('fsBtnUp', 'up');
  setupBtn('fsBtnDown', 'down');
  setupBtn('fsBtnLeft', 'left');
  setupBtn('fsBtnRight', 'right');
  
  document.getElementById('fsBtnA')?.addEventListener('click', handleA);
  document.getElementById('fsBtnB')?.addEventListener('click', handleB);
})();
</script>
  
</body>
</html>
